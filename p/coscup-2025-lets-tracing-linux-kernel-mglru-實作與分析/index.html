<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ"><title>Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ</title><link rel=canonical href=https://wuta0209.github.io/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/><link rel=stylesheet href=/scss/style.min.42217344d95b2e9acb3b1742221f20a0f48c9e795b4199208d577294e9b89e09.css><meta property='og:title' content="Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ"><meta property='og:description' content="Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ"><meta property='og:url' content='https://wuta0209.github.io/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/'><meta property='og:site_name' content='WuTa Blog'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='MGLRU'><meta property='article:tag' content='Linux Kernel'><meta property='article:tag' content='Tracing'><meta property='article:tag' content='Perf'><meta property='article:published_time' content='2025-07-20T13:23:54+08:00'><meta property='article:modified_time' content='2025-07-20T13:23:54+08:00'><meta property='og:image' content='https://wuta0209.github.io/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/coscup.png'><meta name=twitter:title content="Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ"><meta name=twitter:description content="Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://wuta0209.github.io/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/coscup.png'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ›é¸å–®>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_1c6ae99766100603.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>WuTa Blog</a></h1><h2 class=site-description>The best learning is trying to teach.</h2></div></header><ol class=menu-social><li><a href=https://github.com/WuTa0209 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://ithelp.ithome.com.tw/users/20138181 target=_blank title=ITHome rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>AboutMe</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>å¤œæ™šæ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®éŒ„</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#å¤§ç¶±>å¤§ç¶±</a></li><li><a href=#ç°¡ä»‹ä»€éº¼æ˜¯-page-replacement>ç°¡ä»‹ï¼Œä»€éº¼æ˜¯ page replacement?</a><ol><li><a href=#è©³ç´°é—œæ–¼-cpu-è¨˜æ†¶é«”å­˜å–æ©Ÿåˆ¶>è©³ç´°é—œæ–¼ CPU è¨˜æ†¶é«”å­˜å–æ©Ÿåˆ¶</a><ol><li><a href=#cpu-æŸ¥è©¢-tlb>CPU æŸ¥è©¢ TLB</a></li><li><a href=#é—œæ–¼-page-table>é—œæ–¼ Page Table</a></li><li><a href=#é—œæ–¼-page-fault>é—œæ–¼ Page Fault</a></li><li><a href=#é—œæ–¼-page-replacement>é—œæ–¼ page replacement</a></li></ol></li><li><a href=#é—œæ–¼-page-reclaim>é—œæ–¼ Page Reclaim</a></li></ol></li><li><a href=#å›é¡§é—œæ–¼-activeinactive-lru>å›é¡§ï¼Œé—œæ–¼ Active/Inactive LRU</a><ol><li><a href=#inactive-active-lru-list-çš„é‹ä½œ>Inactive-Active LRU list çš„é‹ä½œ:</a></li><li><a href=#é›™-lru-list-è¨­è¨ˆç›®çš„>é›™ LRU list è¨­è¨ˆç›®çš„:</a></li><li><a href=#ç†æƒ³æƒ…æ³ä¸‹-active-inactive-lru-è¡¨ç¾>ç†æƒ³æƒ…æ³ä¸‹ Active-Inactive LRU è¡¨ç¾</a></li><li><a href=#active-inactive-lru-å¯èƒ½çš„å•é¡Œ>Active-Inactive LRU å¯èƒ½çš„å•é¡Œ</a><ol><li><a href=#è£œå……-é—œæ–¼-rmap>è£œå……: é—œæ–¼ Rmap</a></li></ol></li></ol></li><li><a href=#è¿½è¹¤é—œæ–¼è¿½è¹¤-kernel-è£¡ç‰¹å®šå­ç³»çµ±>è¿½è¹¤ï¼Œé—œæ–¼è¿½è¹¤ kernel è£¡ç‰¹å®šå­ç³»çµ±</a><ol><li><a href=#ä½¿ç”¨-stress-ng-è£½é€ è¨˜æ†¶é«”å£“åŠ›>ä½¿ç”¨ <code>stress-ng</code> è£½é€ è¨˜æ†¶é«”å£“åŠ›</a></li><li><a href=#ä½¿ç”¨æ¸¬è©¦ç¨‹å¼æ­é…-cgroup-é™åˆ¶è¨˜æ†¶é«”è³‡æº>ä½¿ç”¨æ¸¬è©¦ç¨‹å¼ï¼Œæ­é… cgroup é™åˆ¶è¨˜æ†¶é«”è³‡æº</a></li><li><a href=#é—œæ–¼-flamegraph-èˆ‡-dot-graph>é—œæ–¼ flamegraph èˆ‡ dot-graph</a></li></ol></li><li><a href=#mglru-æè¿°>MGLRU æè¿°</a><ol><li><a href=#geneartion-æ¦‚å¿µ>Geneartion æ¦‚å¿µ</a></li><li><a href=#è·¯å¾‘1-aging-æ©Ÿåˆ¶>è·¯å¾‘1. Aging æ©Ÿåˆ¶</a></li><li><a href=#è·¯å¾‘2-evict>è·¯å¾‘2. Evict</a><ol><li><a href=#é—œéµå‡½å¼-try_to_shrink_lruvec-åˆ†æ>é—œéµå‡½å¼ <code>try_to_shrink_lruvec</code> åˆ†æ</a></li></ol></li><li><a href=#pid-æ§åˆ¶è¿´è·¯èˆ‡-anonfile-backed-page-å¹³è¡¡>PID æ§åˆ¶è¿´è·¯èˆ‡ anon/file-backed page å¹³è¡¡</a></li><li><a href=#é—œæ–¼-bloom-filter-é™ä½-rmap-é–‹éŠ·>é—œæ–¼ Bloom Filter é™ä½ Rmap é–‹éŠ·</a></li></ol></li><li><a href=#æ¸¬è©¦ç’°å¢ƒ>æ¸¬è©¦ç’°å¢ƒ</a><ol><li><a href=#ä½¿ç”¨-mglru-debugfs>ä½¿ç”¨ MGLRU debugfs</a></li><li><a href=#ä½¿ç”¨-kprobe-è§€æ¸¬-funciton-è¡Œç‚º>ä½¿ç”¨ kprobe è§€æ¸¬ funciton è¡Œç‚º</a></li><li><a href=#éœæ…‹è¿½è¹¤>éœæ…‹è¿½è¹¤</a></li><li><a href=#å‹•æ…‹è¿½è¹¤>å‹•æ…‹è¿½è¹¤</a><ol><li><a href=#ä½¿ç”¨-kernel-module>ä½¿ç”¨ kernel module</a></li><li><a href=#ä½¿ç”¨-bpftrace>ä½¿ç”¨ bpftrace</a></li></ol></li></ol></li><li><a href=#çµè«–>çµè«–</a></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/><img src=/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/coscup_hu_840e27a74180904f.png srcset="/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/coscup_hu_840e27a74180904f.png 800w, /p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/coscup_hu_b98298abfdda454f.png 1600w" width=800 height=533 loading=lazy alt="Featured image of post Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ"></a></div><div class=article-details><header class=article-category><a href=/categories/coscup-2025/>Coscup 2025</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/coscup-2025-lets-tracing-linux-kernel-mglru-%E5%AF%A6%E4%BD%9C%E8%88%87%E5%88%86%E6%9E%90/>Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ</a></h2><h3 class=article-subtitle>Coscup 2025: Let's Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jul 20, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é–±è®€æ™‚é–“: 27 åˆ†é˜</time></div></footer></div></header><section class=article-content><h1 id=coscup-2025-lets-tracing-linux-kernel-mglru-å¯¦ä½œèˆ‡åˆ†æ>Coscup 2025: Let&rsquo;s Tracing Linux Kernel, MGLRU å¯¦ä½œèˆ‡åˆ†æ</h1><h2 id=å¤§ç¶±>å¤§ç¶±</h2><ul><li>ç°¡ä»‹ï¼Œä»€éº¼æ˜¯ page replacement?</li><li>å›é¡§ï¼Œé—œæ–¼ Active/Inactive LRU</li><li>è¿½è¹¤ï¼Œé—œæ–¼è¿½è¹¤ kernelçš„ page replacement</li><li>ä»‹ç´¹ MGLRU</li><li>MGLRU call chain è§£é‡‹<ul><li>Aging</li><li>Eviction</li><li>PID æ§åˆ¶</li><li>Rmap å„ªåŒ–</li></ul></li><li>è§€æ¸¬ MGLRU è¡Œç‚º</li><li>çµè«–</li></ul><h2 id=ç°¡ä»‹ä»€éº¼æ˜¯-page-replacement>ç°¡ä»‹ï¼Œä»€éº¼æ˜¯ page replacement?</h2><p>é¦–å…ˆå›é¡§ Process å­˜å–è¨˜æ†¶é«”çš„æµç¨‹</p><ul><li>CPU å­˜å–è¨˜æ†¶é«”: ç•¶ç¨‹å¼å˜—è©¦å­˜å–è¨˜æ†¶é«”æ™‚ï¼ŒCPU æœƒå…ˆå»æŸ¥è©¢ TLBï¼Œå¦‚æœ TLB Missï¼Œå‰‡æŸ¥è©¢ Page Table</li><li>æŸ¥è©¢ Page Table: å¦‚æœç™¼ç¾ Page Table æ²’æœ‰è©²è™›æ“¬è¨˜æ†¶é«”å°æ‡‰åˆ°çš„å¯¦é«”è¨˜æ†¶é«”æ˜ å°„ï¼Œæˆ–æ˜¯æ˜ å°„æ¨™è¨˜ç‚ºç„¡æ•ˆï¼Œå‰‡ CPU æœƒè§¸ç™¼ Page Faultï¼Œç”¢ç”Ÿ exceptionï¼Œä¸¦é€²å…¥ Page Fault Handler</li><li>é€™æ™‚å€™æœ‰å¹¾å€‹é¸æ“‡ï¼Œå¦‚æœ page å·²ç¶“åœ¨è¨˜æ†¶é«”ï¼Œä½†æ²’æœ‰æ˜ å°„åˆ°ç›®å‰ Process çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œå‰‡åªéœ€è¦æ›´æ–°æ˜ å°„å°±å¯ä»¥ã€‚å¦‚æœ page ä¸åœ¨è¨˜æ†¶é«”ï¼Œéœ€è¦å¾ç¡¬ç¢Ÿè¼‰å…¥ã€‚å¦‚æœ page éƒ½ä¸å¯ä½¿ç”¨ï¼Œå‰‡ç³»çµ±éœ€è¦é¸æ“‡ä¸€å€‹ç­–ç•¥å°‡ç›®å‰å¯¦é«”è¨˜æ†¶é«”çš„ page é€²è¡Œæ›¿æ›ï¼Œå°‡æŸå€‹ page æ›å‡ºåˆ°æ¬¡ç´šè¨˜æ†¶é«”ï¼Œå¦‚ CXL, swap ç­‰ç­‰ï¼Œä»¥é‡‹æ”¾å‡ºç©ºé–“çµ¦æ–°çš„ page ä½¿ç”¨ï¼Œé€™æ™‚å€™å¯èƒ½ä½¿ç”¨ LRU æˆ–æ˜¯ MGLRU ç­‰ç­‰ç­–ç•¥</li></ul><p>å°æ–¼è¨˜æ†¶é«”ï¼Œä¸»è¦å•é¡Œæœ‰å…©å€‹ï¼Œä¸€å€‹æ˜¯ä»€éº¼æ¨£çš„ç‰©ä»¶æ‡‰è©²ä¿ç•™åœ¨ cache ä¸­ï¼Œé€™å€‹ç”± page replacement ç­–ç•¥æ±ºå®šï¼Œåƒæ˜¯ MGLRUï¼Œè€Œå¦ä¸€å€‹è­°é¡Œæ˜¯å¦‚ä½•åœ¨ cache ä¸­æ”¾å…¥æ›´å¤šçš„ç‰©ä»¶ï¼Œé—œæ–¼é€™éƒ¨ä»½è¿‘æœŸçš„è¨è«–ç‚º zramï¼Œä¸éæˆ‘å€‘æœƒå°‡é‡é»æ”¾åœ¨ MGLRUã€‚</p><h3 id=è©³ç´°é—œæ–¼-cpu-è¨˜æ†¶é«”å­˜å–æ©Ÿåˆ¶>è©³ç´°é—œæ–¼ CPU è¨˜æ†¶é«”å­˜å–æ©Ÿåˆ¶</h3><p>ç•¶ç¨‹å¼å˜—è©¦å­˜å–è¨˜æ†¶é«” (è™›æ“¬è¨˜æ†¶é«”) æ™‚ï¼Œæœƒé€²è¡Œä»¥ä¸‹</p><h4 id=cpu-æŸ¥è©¢-tlb>CPU æŸ¥è©¢ TLB</h4><p>ç¢ºèªè™›æ“¬è¨˜æ†¶é«”åœ°å€æ˜¯å°æ‡‰åˆ°å“ªä¸€å€‹å¯¦é«”è¨˜æ†¶é«”åœ°å€</p><ul><li>TLB æŸ¥è©¢: CPU å…ˆæŸ¥è©¢ TLBï¼ŒTLB è£¡é¢å„²å­˜æœ€è¿‘ä½¿ç”¨éå¾—è™›æ“¬è¨˜æ†¶é«”åˆ°å¯¦é«”è¨˜æ†¶é«”ä¹‹é–“çš„æ˜ å°„é—œä¿‚</li><li>TLB Hit: å¦‚æœåœ¨ TLB ä¸­æ‰¾åˆ°å°æ‡‰çš„æ˜ å°„ï¼Œç™¼ç”Ÿ TLB hitï¼Œå‰‡ CPU ç›´æ¥ä½¿ç”¨è©²å¯¦é«”è¨˜æ†¶é«”ä¾†å­˜å–è¨˜æ†¶é«”</li><li>TLB Miss: å¦‚æœ TLB ä¸­æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„æ˜ å°„ï¼Œå‰‡ CPU éœ€è¦å…ˆæŸ¥è©¢ä¸»è¨˜æ†¶é«”ä¸­çš„ Page Table ä¾†ç²å–å¯¦é«”è¨˜æ†¶é«”ï¼Œé€™æ™‚å€™æœƒéœ€è¦é€²è¡Œ Page Table Walk</li></ul><p>å¾—åˆ°å¯¦é«”è¨˜æ†¶é«”åœ°å€å¾Œï¼Œåˆ° CPU cache ä¸­æŸ¥è©¢æ˜¯å¦æœ‰å¯¦é«”è¨˜æ†¶é«”åœ°å€å°æ‡‰çš„è³‡æ–™</p><ul><li>CPU Cache æª¢æŸ¥: CPU é¦–å…ˆæª¢æŸ¥å…¶å…§éƒ¨ Cacheï¼ŒL1, L2, L3 Cacheï¼Œå¦‚æœè³‡æ–™å·²ç¶“è¢«å¿«å–ï¼Œå‰‡æœƒç™¼ç”Ÿ cache hitï¼Œç›´æ¥ä½¿ç”¨è©²è³‡æ–™</li><li>Cache Miss: å¦‚æœ Cache ä¸­æ²’æœ‰éœ€è¦çš„è³‡æ–™ï¼Œæœƒç™¼ç”Ÿ Cache missï¼ŒCPU éœ€è¦å¾ä¸»è¨˜æ†¶é«”ä¸­è®€å–è³‡æ–™</li></ul><h4 id=é—œæ–¼-page-table>é—œæ–¼ Page Table</h4><p>Page Table ä¸­å„²å­˜è™›æ“¬è¨˜æ†¶é«”åˆ°å¯¦é«”è¨˜æ†¶é«”ä¹‹é–“çš„æ˜ å°„é—œä¿‚ï¼Œæœ€å¾Œä¸€å±¤ç‚º PTE (Page Table Entry)ï¼ŒåŒ…å«ä»¥ä¸‹å¹¾å€‹æ¬„ä½</p><ul><li>P (Present Flag): è¡¨ç¤ºè©² page æ˜¯å¦ä½æ–¼å¯¦é«”è¨˜æ†¶é«”ä¸­</li><li>R/W (Read/Write Flag): è¡¨ç¤ºè©² page çš„è®€å¯«æ¬Šé™</li><li>A (Accessed Flag): è¡¨ç¤º Page æ˜¯å¦è¢«å­˜å–é</li><li>D (Dirty Flag): è¡¨ç¤º Page æ˜¯å¦è¢«ä¿®æ”¹é</li></ul><h4 id=é—œæ–¼-page-fault>é—œæ–¼ Page Fault</h4><p>ç•¶ Page Table ä¸­æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ˜ å°„ï¼Œæˆ–æ˜¯æ˜ å°„è¢«æ¨™è¨˜ç‚ºç„¡æ•ˆæ™‚ï¼Œåˆæˆ–è€…æ˜¯å› ç‚ºç¼ºå°‘æ¬Šé™ç­‰ï¼ŒCPU æœƒç”¢ç”Ÿ Page Fault Exceptionï¼Œæ§åˆ¶æ¬Šæœƒè½‰äº¤çµ¦ Page Fault Handlerï¼ŒPage Fault å¯ä»¥åˆ†æˆä»¥ä¸‹å¹¾ç¨®é¡å‹</p><ul><li>Minor Page Fault
ç•¶ process å­˜å–è™›æ“¬è¨˜æ†¶é«”å°æ‡‰åˆ°çš„ page å·²ç¶“å­˜åœ¨æ–¼ç‰©ç†è¨˜æ†¶é«”ï¼Œä½†æ˜¯å°šæœªå»ºç«‹æœ‰æ•ˆçš„æ˜ å°„åˆ° Process Page Tableï¼Œé€™æ™‚å¾Œæœƒè§¸ç™¼ Minor Page Faultï¼Œé€™æ™‚å€™ä¸éœ€è¦ç¡¬ç¢Ÿ I/Oï¼Œåªéœ€è¦æ›´æ–° page table çš„æ˜ å°„æˆ–æ˜¯æ¬Šé™å³å¯æ¢å¾©åŸ·è¡Œ<ul><li>å¸¸è¦‹çš„ç‚º malloc ä¸­çš„ lazy allocationï¼ŒCPU ç™¼ç¾è™›æ“¬è¨˜æ†¶é«”åœ°å€æ²’æœ‰å°æ‡‰çš„å¯¦é«” page frameï¼Œé€™æ™‚ kernel åˆ†é… page frame ä¸¦æ›´æ–° PTEï¼Œæ¥è‘—æ¢å¾©ç¨‹å¼åŸ·è¡Œï¼Œä¸éœ€è¦ç¡¬ç¢Ÿ I/O</li><li>Copy-On-Write (COW): å…±äº« page é¦–æ¬¡å¯«å…¥æ™‚è§¸ç™¼ copy</li><li>å‹•æ…‹å‡½å¼åº«é¦–æ¬¡è¼‰å…¥æ™‚ï¼Œå¦‚æœå…¶ page å·²ç¶“å­˜åœ¨æ–¼ page cacheï¼Œå‰‡æœƒè§¸ç™¼ Minor Page Faultï¼Œkernel åªéœ€è¦æ›´æ–° page table çš„æ˜ å°„ï¼Œæ˜ å°„åˆ° Process address space</li></ul></li><li>Major Page Fault:
ç•¶æ‰€éœ€çš„ page ä¸åœ¨å¯¦é«”è¨˜æ†¶é«”ä¸­ï¼Œéœ€è¦å¾æ¬¡ç´šè¨˜æ†¶é«”ï¼Œå¦‚ç¡¬ç¢Ÿ, zswap, zram ç­‰è¼‰å…¥æ™‚ï¼Œæœƒç™¼ç”Ÿ Major Page Faultï¼Œé€™ç¨® Page Fault è™•ç†éœ€è¦æ¶ˆè€—æ›´å¤šçš„æ™‚é–“ï¼Œå› ç‚ºæ¶‰åŠ I/O æ“ä½œ<ul><li>å¾ zram æˆ–æ˜¯ swap è¼‰å…¥è³‡æ–™</li></ul></li><li>Invalid Page Fault:
ç•¶ Process å­˜å–çš„è¨˜æ†¶é«”åœ°å€ä¸åœ¨ Process çš„è™›æ“¬è¨˜æ†¶é«”ç©ºé–“ä¸­ï¼Œæˆ–æ˜¯é•åå­˜å–æ¬Šé™ï¼Œæœƒç™¼ç”Ÿ Invalid Page Faultã€‚</li></ul><h4 id=é—œæ–¼-page-replacement>é—œæ–¼ page replacement</h4><p>ç•¶ç³»çµ±ä¸­ free page list æ²’æœ‰è¶³å¤ çš„ free page frameï¼Œé€™æ™‚å€™éœ€è¦å•Ÿå‹• page replacement æ©Ÿåˆ¶ã€‚ä½œæ¥­ç³»çµ±æœƒæ ¹æ“šä»¥ä¸‹ç­–ç•¥é¸æ“‡ victim pageï¼Œä¸¦é€²è¡Œ eviction æ“ä½œï¼Œå¸¸è¦‹ç­–ç•¥åŒ…å«ä»¥ä¸‹</p><ul><li>LRU: æ›¿æ›æœ€ä¹…æ²’æœ‰ä½¿ç”¨çš„ Page</li><li>Clock / Second-Chance: ç¡¬é«”æˆæœ¬è¼ƒä½çš„è¿‘ä¼¼ LRU</li><li>MGLRU (Multi-Generational LRU): è‡ª Linux Kernel 6.1 ä¹‹å¾Œå¼•å…¥çš„ç­–ç•¥ï¼Œå°‡ page æ ¹æ“šå­˜æ´»é€±æœŸä»¥åŠ hot, cold åˆ†æˆå¤šå€‹ generation</li></ul><p>æ•´ç†ä»¥ä¸Šï¼Œæˆ‘å€‘çŸ¥é“ page replacement æœƒåœ¨å…©å€‹æƒ…å¢ƒä¸‹è§¸ç™¼</p><ul><li>è¨˜æ†¶é«”å£“åŠ›å¤§æ™‚ (background reclaim): ç•¶ç³»çµ±ç›£æ¸¬åˆ°ç›®å‰è¨˜æ†¶é«”å£“åŠ›å¤§æ™‚ï¼Œå¦‚ç©ºé–’è¨˜æ†¶é«”ç©ºé–“ä½æ–¼æŸå€‹ç‰¹å®šæ°´ä½ï¼Œ<code>kswapd</code> æœƒè¢«å–šé†’ï¼Œä¸»å‹•å›æ”¶ page ç¶­æŒç³»çµ±å¯ç”¨çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œä¸»å‹•é¸å‡ºå“ªä¸€äº› page ç‚º cold page é€™éƒ¨ä»½æœƒéœ€è¦ page replacement é‚è¼¯</li><li>ç”± page fault è§¸ç™¼ (direct reclaim): ç•¶ç™¼ç”Ÿ Major Page Faultï¼Œéœ€è¦åˆ†é… page frame æ™‚ï¼Œå¦‚æœ free page frame ä¸è¶³ï¼Œå‰‡æœƒåŒæ­¥å•Ÿå‹• page replacement æ©Ÿåˆ¶ï¼Œç”± page fault handler ç›´æ¥ evict ç¾æœ‰çš„ pageï¼Œé‡‹æ”¾ç©ºé–“çµ¦æ–°çš„ page ä½¿ç”¨</li></ul><h3 id=é—œæ–¼-page-reclaim>é—œæ–¼ Page Reclaim</h3><p>åœ¨ä¸Šé¢ Major Page Fault ä¸­ï¼Œæåˆ°ç•¶æ²’æœ‰è¶³å¤  free page frame æœƒéœ€è¦å•Ÿå‹• page replacement æ©Ÿåˆ¶ï¼ŒLinux æœƒå•Ÿå‹• Page å›æ”¶æ©Ÿåˆ¶ï¼Œå…·é«”è¡Œç‚ºæ˜¯ç”± (<code>kswapd</code> æˆ–ç›´æ¥ç”± page fault handler å‘¼å« <code>shrink_node()</code>) å˜—è©¦é‡‹æ”¾ page frameã€‚å›æ”¶æ™‚æœƒæ ¹æ“š page å±¬æ–¼çš„ LRU å±¤ç´šï¼Œå¾ cold è³‡æ–™å„ªå…ˆé¸æ“‡ victim page</p><ul><li>LRU page åˆ†é¡ (æœƒå°‡ anon page èˆ‡ file-backed page åˆ†é–‹é€²è¡Œç®¡ç†)<ul><li><code>inactive</code> list: ä½¿ç”¨é »ç‡ä½çš„ pageï¼Œå„ªå…ˆè¢«å›æ”¶</li><li><code>active</code> list: è¿‘æœŸæœ‰è¢«å­˜å–çš„ pageï¼Œå›æ”¶ä¹‹å‰</li><li>MGLRU: å°‡ page æ›´ç´°åˆ†æˆå¤šå€‹ generation</li></ul></li></ul><p>å¦‚æœè¨˜æ†¶é«”å£“åŠ›éå¤§ï¼Œ<code>kswapd</code> ç„¡æ³•å³æ™‚é‡‹æ”¾å¾—åˆ°è¶³å¤ å¤šçš„ free page frameï¼Œå‰‡æœƒå‘¼å« direct reclaimï¼Œæˆ–æ˜¯é€²è¡Œ memory compactionï¼Œåˆä½µå¯ç”¨çš„ free page frameï¼Œå¦‚æœé‚„æ˜¯ç„¡æ³•åˆ†é…ï¼Œå‰‡å¯èƒ½å°è‡´ OOM (Out-of-Memory) æ©Ÿåˆ¶è§¸ç™¼</p><h2 id=å›é¡§é—œæ–¼-activeinactive-lru>å›é¡§ï¼Œé—œæ–¼ Active/Inactive LRU</h2><p>å°±æ˜¯æŠŠ LRU åˆ†æˆå…©å€‹ listï¼Œåˆ†åˆ¥ç‚º active list å’Œ inactive listï¼Œç„¶å¾Œ anon page å’Œ file-backed page äº’ç›¸ç¨ç«‹ï¼Œå†åŠ ä¸Š unevictable page listï¼Œç¸½å…±æœ‰ 5 å€‹ list</p><ul><li>Inactive LRU list: æ–°è¼‰å…¥æˆ–æ˜¯å‰›å‰›ä½¿ç”¨çš„ page ä¸€é–‹å§‹æ”¾å…¥ Inactive list ä¸­ (é€™ä¸€äº› page è™•æ–¼æœªæ´»èºç‹€æ…‹)</li><li>Active LRU list: å¦‚æœæŸå€‹ page åœ¨ Inactive list ä¸­å†æ¬¡è¢«å­˜å– (è©² page ç¬¬äºŒæ¬¡è¢«ä½¿ç”¨)ï¼Œå‰‡è©² page æœƒè¢« promote åˆ° Active listï¼Œä¸¦ä¸”è¢«æ¨™è¨˜æˆ Active pageã€‚Active LRU list ä¸­çš„ page è¡¨ç¤ºæœ€è¿‘å¸¸ç”¨æˆ–æ˜¯ hot page</li></ul><p>5 å€‹ list å¯ä»¥åœ¨ Linux Kernel åŸå§‹ç¢¼ä¸­çœ‹åˆ°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>enum</span> <span class=n>lru_list</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LRU_INACTIVE_ANON</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LRU_ACTIVE_ANON</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LRU_INACTIVE_FILE</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LRU_ACTIVE_FILE</span> <span class=o>=</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>LRU_UNEVICTABLE</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>NR_LRU_LISTS</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>è€Œé€™ä¸€äº› list æœƒå­˜æ”¾åœ¨ lruvec ä¸­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>lruvec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>list_head</span> <span class=n>lists</span><span class=p>[</span><span class=n>NR_LRU_LISTS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>æ–°çš„ page é è¨­æœƒæ”¾å…¥ Inactive LRUï¼Œç•¶è©² page å†æ¬¡å­˜å–ä¹‹å¾Œæ‰æœƒç§»å‹•åˆ° Active LRU</li><li>è¨˜æ†¶é«”é–‹å§‹å‡ºç¾å£“åŠ›ä¹‹å¾Œæœƒé€²è¡Œ Evictionï¼ŒEviction çš„è¡Œç‚ºæ˜¯å¾ Inactive LRU çš„æœ«ç«¯é–‹å§‹å›æ”¶</li><li>å¦‚æœ Inactive LRU ä¸­ page æ•¸é‡æ¯”è¼ƒä½ï¼Œå‰‡å¾ Active LRU å°¾ç«¯é–‹å§‹ç§»å‹• page åˆ° Inactive LRU</li></ul><h3 id=inactive-active-lru-list-çš„é‹ä½œ>Inactive-Active LRU list çš„é‹ä½œ:</h3><p>ç•¶ç³»çµ±è¨˜æ†¶é«”å……è¶³æ™‚ï¼Œpage å¯ä»¥åœ¨å…©å€‹ LRU list ä¸­ç§»å‹•ã€‚å¦‚æœå‡ºç¾è¨˜æ†¶é«”å£“åŠ›ï¼Œæœ‰ page éœ€è¦é€²è¡Œ Evict (Eviction: å°‡ page å¾è¨˜æ†¶é«”ä¸­ç§»é™¤)ï¼ŒKernel æœƒå¾ Inactive LRU list çš„æœ«ç«¯é–‹å§‹å›æ”¶ä¸å¸¸ä½¿ç”¨çš„ pageã€‚é€™æ„å‘³è‘—åªä½¿ç”¨ä¸€æ¬¡çš„é‚£ä¸€äº› page æœƒè¢«å„ªå…ˆæ·˜æ±°ï¼Œè€Œ Active LRU list ä¸­çš„ page æœƒè¢«ä¿ç•™ã€‚</p><p>å¦‚æœ Inactive LRU list é•·åº¦å¤ªçŸ­ï¼Œä¸è¶³ä»¥æä¾› page å›æ”¶ï¼Œå‰‡é€™æ™‚å€™æœƒå¾ Active LRU list æœ«ç«¯é¸å‡ºä¸€äº› page é€²è¡Œ demote åˆ° Inactive LRU listï¼Œå¢åŠ  kernel å¯ä»¥å›æ”¶çš„ page æ•¸é‡ã€‚</p><h3 id=é›™-lru-list-è¨­è¨ˆç›®çš„>é›™ LRU list è¨­è¨ˆç›®çš„:</h3><p>é€™æ¨£è¨­è¨ˆçš„æ ¸å¿ƒæ¦‚å¿µæ˜¯é¿å…å–®æ¬¡å­˜å–çš„ page å»å¹²æ“¾ working setï¼Œå‡æƒ³ä¸€ä¸‹ï¼Œå¦‚æœåªæœ‰ä¸€å€‹ LRU listï¼Œç”±æ–¼ list å¤§å°æœ‰é™ (éš±å« cache å¤§å°æœ‰é™)ï¼Œé‚£äº›åªå­˜å–ä¸€æ¬¡çš„ page å¾ˆæœ‰å¯èƒ½æœƒæŠŠé »ç¹å­˜å–çš„ page çµ¦æ“ å‡º LRU listï¼Œå°æ•´å€‹ç¨‹å¼çš„ working set é€ æˆå¹²æ“¾ã€‚Active LRU list ç›¸ç•¶æ–¼ working set çš„ä¿è­·å€ï¼ŒInactive LRU list å‰‡æ˜¯å®¹ç´æœ€è¿‘æ²’æœ‰é‡è¤‡ä½¿ç”¨çš„ pageã€‚</p><p>é›™ list å¯ä»¥å¢åŠ ä»–çš„ç‹€æ…‹è¡¨ç¤ºæ•¸é‡ (åŒ…å« timestamp)ï¼Œåªæœ‰å–® listï¼Œå¯ä»¥è¡¨ç¤º hot/cold/dirty</p><p>å°æ–¼æƒææ¨¡å¼ï¼Œé›™ list å¯ä»¥è®“ä»–åªæ±¡æŸ“åˆ° inactive list (ä¸éé€™éƒ¨ä»½è¦çœ‹ promote é‚è¼¯)</p><p>2Q lRU èˆ‡ active/inactive æ˜¯ä¸€æ¨£çš„ï¼ŒMGLRU å‹•æ©Ÿ: ç‚ºäº†ææ˜‡é‘‘åˆ¥åº¦ï¼Œåªæœ‰åˆ†å…©å±¤å¯èƒ½è¦æƒæå¾ˆä¹…</p><p>:::info
working set å®šç¾©: æŒ‡ä¸€å€‹æ‡‰ç”¨ç¨‹å¼åœ¨ä¸€æ®µæ™‚é–“å…§æ­£å¸¸åŸ·è¡Œæ‰€éœ€è¦çš„æ™‚å¸¸å­˜å–çš„ pageï¼Œä¹Ÿå°±æ˜¯ hot page æ‰€æ§‹æˆçš„é›†åˆ
:::</p><h3 id=ç†æƒ³æƒ…æ³ä¸‹-active-inactive-lru-è¡¨ç¾>ç†æƒ³æƒ…æ³ä¸‹ Active-Inactive LRU è¡¨ç¾</h3><p>ç†æƒ³æ³ä¸‹æˆ‘å€‘å¸Œæœ› Active-Inactive LRU èƒ½å¤ å¾ˆå¥½çš„å»é¿å…é‚£ä¸€äº›ä¸€æ¬¡å­˜å–çš„ page å°ä¸€å€‹æ‡‰ç”¨ç¨‹å¼çš„ working set é€ æˆå¹²æ“¾ã€‚ä¹Ÿå°±æ˜¯ working set ä¸­çš„ page ä¸æœƒè¢« evictï¼Œæˆ‘å€‘å¸Œæœ›æœ‰ä¸€å€‹è¶³å¤ é•·çš„ Inactive LRU ä¾†é¿å…å° working set çš„å¹²æ“¾ã€‚</p><p>èˆ‰ä¸€å€‹ä¾‹å­ï¼Œä¸€å€‹æ‡‰ç”¨ç¨‹å¼çš„ working set å¤§å°ç‚º 6 å€‹ pageï¼Œè€Œ Inactive LRU é•·åº¦ç‚º 8ï¼Œæ¥è‘—é–‹å§‹å­˜å– pageï¼Œpage ä¾åºé€²å…¥åˆ° Inactive LRUï¼Œæ¥è‘—æˆ‘å€‘ç¬¬äºŒæ¬¡å­˜å– pageï¼Œç”±æ–¼ Inactive LRU é•·åº¦å¤§æ–¼ 6ï¼Œæ‰€ä»¥æ‰€æœ‰ page éƒ½ç•™åœ¨è¨˜æ†¶é«”ä¸­ï¼Œæœ€çµ‚é€™ä¸€äº› page éƒ½å¯ä»¥è¢« promote åˆ° active list ä¸­ï¼Œä¹Ÿå°±æ˜¯æ•´å€‹æ‡‰ç”¨ç¨‹å¼çš„ working set é †åˆ©ä¿ç•™åœ¨è¨˜æ†¶é«”ä¸­ã€‚</p><h3 id=active-inactive-lru-å¯èƒ½çš„å•é¡Œ>Active-Inactive LRU å¯èƒ½çš„å•é¡Œ</h3><p>Active-Inactive LRU å•é¡Œåœ¨ç†æƒ³æƒ…æ³ä¸‹å¯ä»¥ä¿è­· working setï¼Œä½†åœ¨å¯¦éš›æƒ…æ³ä¸‹å­˜åœ¨ä»¥ä¸‹ä¸è¶³</p><ul><li>Rmap é–‹éŠ·å•é¡Œ: æ¯æ¬¡åœ¨å›æ”¶æˆ–æ˜¯æª¢æŸ¥ page çš„æ™‚å€™éƒ½éœ€è¦é€šé Rmap æ‰¾åˆ°ç›¸é—œçš„ page table entriesï¼Œè¦çŸ¥é“é€™å€‹ page æ˜¯è¢«å“ªä¸€äº› process æ‰€ä½¿ç”¨ï¼Œé€™å° CPU æœ‰è‘—è«å¤§çš„é–‹éŠ·</li><li>page ç†±åº¦æ¢æ¸¬: å¿…é ˆç­‰å¾…è©² page å†æ¬¡è¢«å­˜å– (ç”¢ç”Ÿ page fault) æ‰èƒ½åˆ¤æ–·è©² page ç‚º hot page ä¸¦å°‡å…¶èºé·åˆ° Active LRU list</li><li>åˆ†é¡ç°¡å–®: åªæœ‰ Inactive/Activeï¼Œä¹Ÿå°±æ˜¯ page ä¸æ˜¯ hot å°±æ˜¯ coldï¼Œåˆ†é¡ä¸Šä¸å¤ ç´°ç·»</li></ul><p>ä¸Šé¢çš„å•é¡Œåœ¨éç†æƒ³æƒ…æ³ä¸‹ working set å¯èƒ½æœƒå—åˆ°å¾ˆå¤§çš„å½±éŸ¿ï¼Œç„¡æ³•æœ‰æ•ˆçš„ä¿ç•™åœ¨è¨˜æ†¶é«”ä¸­ï¼Œä¾‹å¦‚ working set ä¸­ page å­˜å–ç›¸å°è·é›¢é•·ï¼Œè·é›¢è¶…é Inactive LRU list çš„å¤§å°ï¼Œåœ¨ Active/Inactive LRU list ä¸­å¯èƒ½æœƒå‡ºç¾é »ç¹å°‡ page æ›å‡ºæ›å…¥çš„æƒ…æ³ (Thrashing)ã€‚</p><p>ç‚ºäº†è§£æ±ºä¸Šé¢çš„å•é¡Œï¼Œå¸Œæœ›æœ‰å€‹æ¼”ç®—æ³•èƒ½å¤ æ¸›å°‘ Rmap é–‹éŠ·ä¸¦ä¸”æä¾›æ›´ç´°ç·»çš„åˆ†é¡ï¼Œç‚ºæ­¤ï¼ŒMGLRU åœ¨ Linux Kernel 6.1 ç‰ˆæ­£å¼å¼•å…¥</p><h4 id=è£œå……-é—œæ–¼-rmap>è£œå……: é—œæ–¼ Rmap</h4><p>Rmap ç‚º Linux Kernel ä¸­ç”¨æ–¼è¿½è¹¤ Page Frame è¢«å“ªä¸€äº›è™›æ“¬è¨˜æ†¶é«”åœ°å€æ˜ å°„çš„æ©Ÿåˆ¶ï¼Œæ ¸å¿ƒåŠŸèƒ½ç‚ºä»¥ä¸‹</p><ul><li>åå‘æŸ¥è©¢ï¼Œçµ¦å®šä¸€å€‹ Page Frameï¼Œæ‰¾å‡ºæ‰€æœ‰æ˜ å°„ä»–çš„è™›æ“¬è¨˜æ†¶é«”åœ°å€ï¼Œä¹Ÿå°±æ˜¯è©² Page Frame çš„ä½¿ç”¨æƒ…æ³ï¼Œéç¨‹ä¸­éœ€è¦éæ­· Process çš„ Page Table</li><li>åœ¨ page å›æ”¶æˆ–æ˜¯é·ç§»æ™‚ï¼Œéœ€è¦æ›´æ–°æ‰€æœ‰ç›¸é—œ Process çš„ Page Tableï¼Œç¢ºä¿è™›æ“¬è¨˜æ†¶é«”åœ°å€å’Œå¯¦é«”è¨˜æ†¶é«”åœ°å€ä¹‹é–“çš„ä¸€è‡´æ€§</li></ul><p>Rmap åœ¨ Page Replacement ä¸­é€šå¸¸æœƒåœ¨ä»¥ä¸‹å…©å€‹æƒ…æ³ä¸‹è§¸ç™¼</p><ul><li>Page Reclaim: ç•¶è¨˜æ†¶é«”å£“åŠ›å¤§æ™‚ï¼Œéœ€è¦å›æ”¶ä¸å¸¸ä½¿ç”¨çš„ pageï¼Œé€™æ™‚å¾Œæœƒä½¿ç”¨ Rmap ä¾†æ‰¾åˆ°å“ªä¸€äº› Process æ­£åœ¨ä½¿ç”¨è©² Page Frameã€‚æ¥è‘—æœƒå»æ›´æ”¹é€™ä¸€äº› Process çš„ Page Tableï¼Œç§»é™¤é€™ä¸€äº› Process å°æ–¼ Page Frame çš„æ˜ å°„ï¼Œè®“ Page Frame å¯ä»¥è¢«é‡‹æ”¾</li><li>Page Migration: ç•¶éœ€è¦é€²è¡Œ Page Migrationï¼Œä¾‹å¦‚å°‡ Page ç§»å‹•åˆ°å…¶ä»– NUMA ç¯€é»ä¸Šé¢å„ªåŒ–è³‡æ–™å­˜å–ï¼Œé€™æ™‚å€™ Rmap æœƒç”¨ä¾†æ›´æ–°æ‰€æœ‰æ˜ å°„è©² Page Frame çš„ Process çš„ Page Table ä¸­è™›æ“¬è¨˜æ†¶é«”åœ°å€ï¼Œä½¿å…¶æŒ‡å‘åˆ° Page Frame æ–°çš„ä½ç½®</li></ul><p>ç•¶ Kernel éœ€è¦å›æ”¶ä¸€å€‹ page æ™‚ï¼Œéœ€è¦åŸ·è¡Œä»¥ä¸‹æ“ä½œ</p><ol><li>è—‰ç”± page replacement æ©Ÿåˆ¶é¸å‡º Victim Pageï¼Œé€šå¸¸é€™å€‹ Page ç‚º Cold Page</li><li>æ¥è‘—æª¢æŸ¥ Page ç‹€æ…‹ï¼Œå¦‚æœæ˜¯ Dirty éœ€è¦ write-backï¼Œå¦‚æœæ˜¯å…±äº« Pageï¼Œéœ€è¦æ›´æ–°è©² Page é—œè¯çš„æ‰€æœ‰ Process çš„ Page Table</li><li>æ¥è‘—éœ€è¦æ¸…é™¤è©² Page ç›¸é—œçš„æ‰€æœ‰ PTE ä¸­ Present æ¨™èªŒï¼Œè¡¨ç¤ºè©² Page å·²ç¶“ä¸åœ¨è¨˜æ†¶é«”ä¸­</li></ol><p>Rmap åœ¨ä¸Šé¢å…±äº« page è™•ç†ä»¥åŠå­˜å–è¨Šæ¯è’é›†æ™‚éƒ½éœ€è¦é€²è¡Œå°æ‡‰å‘¼å«</p><ol><li>å¦‚æœ Page Frame è¢«å¤šçš„ Process å…±äº«ï¼Œéœ€è¦é€šé Rmap æ‰¾åˆ°æ‰€æœ‰ç›¸é—œ PTE ä¸¦æ›´æ–°</li><li>æª¢æŸ¥ PTE çš„ Accessed, Dirty ç­‰æ¨™è¨˜ï¼Œè¼”åŠ©åˆ¤æ–· Page çš„ç†±åº¦</li></ol><h2 id=è¿½è¹¤é—œæ–¼è¿½è¹¤-kernel-è£¡ç‰¹å®šå­ç³»çµ±>è¿½è¹¤ï¼Œé—œæ–¼è¿½è¹¤ kernel è£¡ç‰¹å®šå­ç³»çµ±</h2><p>æ ¹æ“šæˆ‘å€‘ä¸Šé¢çš„æ¨è«–ï¼ŒMGLRU çš„æ•´å€‹æµç¨‹æœƒåœ¨å…©å€‹æƒ…æ³è§¸ç™¼</p><ul><li>ç•¶ page fault ç™¼ç”Ÿæ™‚</li><li>ç•¶è¨˜æ†¶é«”å£“åŠ›å¤§æ™‚ï¼Œè§¸ç™¼ swap æ©Ÿåˆ¶æ™‚</li></ul><p>ä¹Ÿå°±æ˜¯æˆ‘å€‘å¯ä»¥å˜—è©¦è£½é€ è¨˜æ†¶é«”å£“åŠ›å¤§çš„å ´æ™¯ï¼Œå–šé†’ <code>kswapd</code> è§¸ç™¼ MGLRU æˆ–æ˜¯ LRU çš„å›æ”¶æ©Ÿåˆ¶ï¼Œå…·é«”å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸‰ç¨®ä½œæ³•</p><ul><li>ä½¿ç”¨ <code>stress-ng</code> è£½é€ è¨˜æ†¶é«”å£“åŠ›</li><li>ä½¿ç”¨ç‰¹å®š workloadï¼Œæ¥è‘—ä½¿ç”¨ <code>cgroup</code> é™åˆ¶å…¶èƒ½å¤ ä½¿ç”¨çš„è¨˜æ†¶é«”è³‡æº</li><li>ä¿®æ”¹é–‹æ©Ÿçš„ kernel-parameterï¼Œæ›´æ”¹ç³»çµ±å¯ä»¥ä½¿ç”¨çš„è¨˜æ†¶é«”å¤§å°ï¼Œæ¥è‘—åŸ·è¡Œæ­£å¸¸ workload</li></ul><p>æˆ‘å€‘å¯ä»¥å…ˆä½¿ç”¨ perf å»æŠ“å– workload æœŸé–“çš„ç³»çµ± call stackï¼Œå¾—åˆ° perf.dataï¼Œæ¥è‘—å°é€™å€‹è³‡æ–™é€²è¡Œåˆ†æï¼Œå¾—çŸ¥ kernel è£¡é¢æŸå€‹ function çš„åŸ·è¡Œæµç¨‹ï¼Œå¦‚ mglru</p><h3 id=ä½¿ç”¨-stress-ng-è£½é€ è¨˜æ†¶é«”å£“åŠ›>ä½¿ç”¨ <code>stress-ng</code> è£½é€ è¨˜æ†¶é«”å£“åŠ›</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ stress-ng --vm <span class=m>4</span> --vm-bytes 123G --vm-keep --timeout 30s
</span></span></code></pre></td></tr></table></div></div><h3 id=ä½¿ç”¨æ¸¬è©¦ç¨‹å¼æ­é…-cgroup-é™åˆ¶è¨˜æ†¶é«”è³‡æº>ä½¿ç”¨æ¸¬è©¦ç¨‹å¼ï¼Œæ­é… cgroup é™åˆ¶è¨˜æ†¶é«”è³‡æº</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>110</span> <span class=o>*</span> <span class=n>GB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>buffer</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>pagesize</span> <span class=o>=</span> <span class=nf>get_page_size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=nf>posix_memalign</span><span class=p>(</span><span class=o>&amp;</span><span class=n>buffer</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;va_pa_map.txt&#34;</span><span class=p>,</span> <span class=s>&#34;w&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;posix_memalign failed: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>strerror</span><span class=p>(</span><span class=n>ret</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;malloc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Allocating and touching 110 GB...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>volatile</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=n>pagesize</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>counter</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>volatile</span> <span class=kt>char</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>buffer</span> <span class=o>+</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>  <span class=c1>// touch page
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>asm</span> <span class=k>volatile</span><span class=p>(</span><span class=s>&#34;&#34;</span> <span class=o>:::</span> <span class=s>&#34;memory&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>uintptr_t</span> <span class=n>va</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint64_t</span> <span class=n>pa</span> <span class=o>=</span> <span class=nf>get_physical_address</span><span class=p>(</span><span class=n>va</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pa</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[USER] VA: 0x%lx -&gt; PA: not mapped</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>va</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>fprintf</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=s>&#34;[USER] VA: 0x%lx -&gt; PA: not mapped</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>va</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[USER] VA: 0x%lx -&gt; PA: 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>va</span><span class=p>,</span> <span class=n>pa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>fprintf</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=s>&#34;[USER] VA: 0x%lx -&gt; PA: 0x%lx</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>va</span><span class=p>,</span> <span class=n>pa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Counter = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>counter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Sleeping to allow kernel reclaim...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>sleep</span><span class=p>(</span><span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥è‘—ä½¿ç”¨ cgroup åŸ·è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>SLICE_NAME</span><span class=o>=</span>appdemo.slice
</span></span><span class=line><span class=cl><span class=nv>UNIT_NAME</span><span class=o>=</span>alloc_<span class=k>$(</span>date +%s<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>MEM_LIMIT</span><span class=o>=</span><span class=s2>&#34;300M&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[*] build systemd sliceï¼š</span><span class=nv>$SLICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># create slice, limit memory resource</span>
</span></span><span class=line><span class=cl>sudo systemctl set-property --runtime <span class=s2>&#34;</span><span class=nv>$SLICE_NAME</span><span class=s2>&#34;</span> <span class=nv>MemoryMax</span><span class=o>=</span><span class=nv>$MEM_LIMIT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[*] start running workload, running in slice&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sudo systemd-run --unit<span class=o>=</span><span class=s2>&#34;</span><span class=nv>$UNIT_NAME</span><span class=s2>&#34;</span> --slice<span class=o>=</span><span class=s2>&#34;</span><span class=nv>$SLICE_NAME</span><span class=s2>&#34;</span> --pty --same-dir ./alloc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[*] workload finish, try cleanup&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cleanup</span>
</span></span><span class=line><span class=cl>sudo systemctl stop <span class=s2>&#34;</span><span class=nv>$UNIT_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>sudo systemctl reset-failed <span class=s2>&#34;</span><span class=nv>$UNIT_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>sudo systemctl stop <span class=s2>&#34;</span><span class=nv>$SLICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>CGROUP_PATH</span><span class=o>=</span><span class=s2>&#34;/sys/fs/cgroup/memory/</span><span class=nv>$SLICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -d <span class=s2>&#34;</span><span class=nv>$CGROUP_PATH</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[*] waiting for cleanup&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=o>[</span> -s <span class=s2>&#34;</span><span class=nv>$CGROUP_PATH</span><span class=s2>/cgroup.procs&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        sleep 0.5
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[*] remove cgroupï¼š</span><span class=nv>$CGROUP_PATH</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    sudo rmdir <span class=s2>&#34;</span><span class=nv>$CGROUP_PATH</span><span class=s2>&#34;</span> 2&gt;/dev/null <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;Error&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[*] Done&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=é—œæ–¼-flamegraph-èˆ‡-dot-graph>é—œæ–¼ flamegraph èˆ‡ dot-graph</h3><p>flamegraph ç‚ºè¦–è¦ºåŒ–å·¥å…·ï¼Œç”¨ä¾†é¡¯ç¤ºç¨‹å¼åœ¨åŸ·è¡ŒæœŸé–“çš„ stack tracesï¼Œå¯ä»¥ç”¨ä¾†å¾—çŸ¥æŸå€‹ç³»çµ±çš„æ•ˆèƒ½ç“¶é ¸ä»¥åŠåˆ†æå‡½å¼å‘¼å«é—œä¿‚ã€‚ä»¥ Linux ä¸­çš„ä½¿ç”¨ï¼Œæˆ‘å€‘å¯ä»¥å°‡ perf.data ä½œç‚ºå¾Œç«¯è³‡æ–™ï¼Œæ¥è‘—é€šéå‰ç«¯è…³æœ¬å° perf.data é€²è¡Œéæ¿¾ä¹‹å¾Œå¾—åˆ° flamegraphã€‚</p><p>ä»¥ä¸‹ç‚ºé€šé <code>perf report</code> æª¢è¦–çš„éƒ¨ä»½åŸå§‹è³‡æ–™</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kswapd0      73 [002] 4400339479.836174:   15575919 cycles:P: 
</span></span><span class=line><span class=cl>        ffffffff8122b313 shrink_folio_list+0x143 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff8122f903 evict_folios+0x153 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff81231285 lru_gen_shrink_node+0x125 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff81231f1c balance_pgdat+0x29c ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff81232593 kswapd+0x1e3 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff810c1bf7 kthread+0xd7 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff810441fc ret_from_fork+0x3c ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff8100267a ret_from_fork_asm+0x1a ([kernel.kallsyms])
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kswapd0      73 [002] 4400339479.836174:   15575919 cycles:P: 
</span></span><span class=line><span class=cl>        ffffffff81225938 folio_update_gen+0x38 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff8127486a walk_pgd_range+0x24a ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff812750eb __walk_page_range+0x19b ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff8127525c walk_page_range+0x14c ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff8123049f try_to_inc_max_seq+0x46f ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff81231110 get_nr_to_scan+0x60 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff8123126b lru_gen_shrink_node+0x10b ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff81231f1c balance_pgdat+0x29c ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff81232593 kswapd+0x1e3 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff810c1bf7 kthread+0xd7 ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff810441fc ret_from_fork+0x3c ([kernel.kallsyms])
</span></span><span class=line><span class=cl>        ffffffff8100267a ret_from_fork_asm+0x1a ([kernel.kallsyms])
</span></span></code></pre></td></tr></table></div></div><p>ä»¥ä¸‹ç‚º perf.data éæ¿¾ä¹‹å¾Œå¾—åˆ°çš„ flamegraph</p><p><img src=https://hackmd.io/_uploads/SyghIoyeee.png loading=lazy alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo perf record -F <span class=m>99</span> --call-graph dwarf -ag -- sleep <span class=m>60</span>
</span></span><span class=line><span class=cl><span class=c1># running workload</span>
</span></span><span class=line><span class=cl>$ sudo perf script &gt; mglru_trace.perf
</span></span><span class=line><span class=cl>$ ./FlameGraph/stackcollapse-perf.pl mglru_trace.perf &gt; mglru_folded.txt
</span></span><span class=line><span class=cl>$ ./FlameGraph/flamegraph.pl --title<span class=o>=</span><span class=s2>&#34;MGLRU Memory Reclaim&#34;</span> --width <span class=m>2000</span> --colors mem mglru_folded.txt &gt; mglru_flame.svg
</span></span></code></pre></td></tr></table></div></div><p><img src=https://hackmd.io/_uploads/B1oNadU8lx.png loading=lazy alt=image></p><p>:::info
ä½¿ç”¨ DWARF å¯ä»¥æä¾›æ›´å¤š debug-infoï¼Œè©³ç´°å¯ä»¥åƒè€ƒ Kernel Recipes 2017 - Perf in Netflix - Brendan Gregg
:::</p><p>å¯ä»¥çœ‹åˆ°æ•¸æ“šéå¸¸çš„é¾å¤§ï¼Œé€™æ™‚å€™æˆ‘å€‘éœ€è¦å°æˆ‘å€‘æ„Ÿèˆˆè¶£çš„éƒ¨ä»½é€²è¡ŒäºŒæ¬¡éæ¿¾ï¼Œæˆ‘å€‘æ„Ÿèˆˆè¶£çš„ç›®æ¨™ç‚º mglruï¼Œè€Œæˆ‘å€‘ä¸Šé¢æ¨è«–å¾—åˆ° mglru æœƒåœ¨è¨˜æ†¶é«”å£“åŠ›å¤§æ™‚åŸ·è¡Œï¼ŒLinux åœ¨è¨˜æ†¶é«”å£“åŠ›å¤§æ™‚æœƒè§¸ç™¼ swap æ©Ÿåˆ¶ï¼Œè€Œ swap æ©Ÿåˆ¶æ˜¯ç”± kswapd åŸ·è¡Œï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥éæ¿¾å‡ºé—œæ–¼ kswapd çš„è³‡æ–™ä¾†å¾—åˆ° mglru çš„ call stack</p><p><img src=https://hackmd.io/_uploads/rkS1vjyexx.png loading=lazy alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ grep -E <span class=s2>&#34;kswapd0&#34;</span> mglru_folded.txt <span class=p>|</span> ./FlameGraph/flamegraph.pl --colors mem --width <span class=m>2000</span> --title<span class=o>=</span><span class=s2>&#34;MGLRU&#34;</span> &gt; mglru_specific.svg
</span></span></code></pre></td></tr></table></div></div><p>å¾ä¸Šåœ–æˆ‘å€‘å°±å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°æ•´å€‹ mglru çš„ stack tracesã€‚ä¸Šé¢éæ¿¾å‡ºçš„ï¼Œæ˜¯é‡å°è¨˜æ†¶é«”å£“åŠ›å¤§æ™‚ï¼Œè§¸ç™¼ swap æ©Ÿåˆ¶ã€‚</p><p>ç”± kswapd çš„åœ–æˆ‘å€‘å¯ä»¥çœ‹å‡ºå­˜åœ¨å…©æ¢ä¸»è¦è·¯å¾‘ï¼Œåˆ†åˆ¥ç‚º</p><p>è·¯å¾‘1. kswapd -> balance_pgdat -> shrink_node -> shrink_one -> try_to_inc_max_seq -> walk_page_range</p><p>è·¯å¾‘2. kswapd -> balance_pgdat -> shrink_node -> shrink_one -> try_to_shrink_lruvec</p><p>ä¸‹é¢æˆ‘å€‘ä¹Ÿå¯ä»¥é‡å° page fault é€²è¡Œéæ¿¾ï¼Œå¾—åˆ°ä»¥ä¸‹ flamegraph</p><p><img src=https://hackmd.io/_uploads/rkh-Psyegx.png loading=lazy alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ grep -E <span class=s1>&#39;lru|folio|shrink|refault&#39;</span> mglru_folded.txt <span class=p>|</span> head -n <span class=m>20</span> &gt; page_fault_info_mglru.txt
</span></span></code></pre></td></tr></table></div></div><p>ç”± page fault çš„åœ–æˆ‘å€‘å¯ä»¥çœ‹å‡ºä¸€æ¢ä¸»è¦è·¯å¾‘
è·¯å¾‘3. exec_page_fault -> do_fault -> filemap_fault -> lru_add -> lru_gen_add_folio</p><p>ç”± flamegraph åˆ†æ mglruï¼Œæˆ‘å€‘å¾—åˆ° mglru å­˜åœ¨ä¸‰æ¢ä¸»è¦ stack straces è·¯å¾‘ï¼Œä½œç”¨åˆ†åˆ¥ç‚ºä»¥ä¸‹
ä½œç”¨åˆ†åˆ¥ç‚ºä»¥ä¸‹ä½œç”¨åˆ†åˆ¥ç‚ºä»¥ä¸‹</p><ul><li>è·¯å¾‘1. Promote/Aging (hot page å‡ç´šï¼Œç”¢ç”Ÿæ–°çš„ gen)</li><li>è·¯å¾‘2. Evict / Refault (ç”¨æ–¼ page æ·˜æ±°)</li><li>è·¯å¾‘3. Page Fault (å°‡ page åŠ å…¥åˆ°æœ€æ–° genï¼Œä¹Ÿå°±æ˜¯ <code>max_seq</code>)</li></ul><p>å°æ–¼è·¯å¾‘åˆ†æï¼Œæˆ‘å€‘ä¹Ÿå¯ä»¥ä½¿ç”¨ dot-graph é€²è¡Œåˆ†æï¼Œå¯ä»¥æ›´åŠ å…·é«”çš„çœ‹åˆ° function ä¹‹é–“çš„å‘¼å«é—œä¿‚
<img src=https://hackmd.io/_uploads/SJzzmiuxxx.png loading=lazy alt=image></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat mglru_trace.perf <span class=p>|</span> FlameGraph/stackcollapse-perf.pl &gt; out.collapse
</span></span><span class=line><span class=cl>$ gprof2dot.py -f collapse out.collapse <span class=p>|</span> dot -Tpng -o output.png
</span></span></code></pre></td></tr></table></div></div><h2 id=mglru-æè¿°>MGLRU æè¿°</h2><p>MGLRU æ ¸å¿ƒæƒ³æ³•æ˜¯å°‡ page æŒ‰ç…§ç†±åº¦åˆ†å±¤ç®¡ç†ï¼Œä½†ç›¸æ¯”èµ· Inactive/Active LRU listï¼ŒMGLRU å°‡ page å€åˆ†æˆå¤šå€‹ generationã€‚æ¯å€‹ page å°æ‡‰åˆ°ä¸€å€‹ gen å€¼ï¼Œè¡¨ç¤ºè©² page å±¬æ–¼å“ªä¸€å€‹ geneartionã€‚</p><p>ä»¥ä¸‹ç‚º MGLRU ä¸­é—œéµéƒ¨ä»½ï¼Œå¤§è‡´ä¸Šå¯ä»¥åˆ†æˆä»¥ä¸‹äº”å€‹éƒ¨ä»½</p><ul><li>Geneartion æ¦‚å¿µ: page å…©ç¨®åˆ†é¡ï¼Œgen ä»¥åŠ tier</li><li>Rmap éæ­·ï¼Œå¾—çŸ¥ä¸€å€‹ page/folio æ˜¯å¦ç‚º young</li><li>Page Table Walk: æŸ¥è©¢ Page Table æŸ¥çœ‹ PTE æ˜¯å¦ç‚º young</li><li>Bloom Filter: ç¸®å° Page Table Walk éœ€è¦èµ°è¨ªçš„ç¯„åœ</li><li>PID æ§åˆ¶å™¨: ç”¨ä¾†æ§åˆ¶å›æ”¶çš„ page é¡å‹ä»¥åŠä¿è­· page</li></ul><h3 id=geneartion-æ¦‚å¿µ>Geneartion æ¦‚å¿µ</h3><p>MGLRU åˆ†é¡ page ä¸»è¦ä½¿ç”¨ä¸Šé¢ Gen ä»¥åŠ Tierï¼ŒGen å’Œ Tier ç‚ºä¸åŒçš„æ¦‚å¿µï¼Œä»¥ä¸‹è©³ç´°æè¿°</p><ul><li><p>ä¸–ä»£ (Gen):</p><ul><li>Gen æ„ç¾©: æ¯å€‹ page å±¬æ–¼ä¸€å€‹ genï¼Œè¡¨ç¤º page çš„ç†±åº¦æˆ–æ˜¯å¹´é½¡ã€‚ä½¿ç”¨ sliding windows å¯¦ä½œ</li><li>Gen è¨ˆç®—: gen æ˜¯ç”± <code>min_seq</code> èˆ‡ <code>max_seq</code> å®šç¾©ï¼Œé€šé <code>seq % MAX_NR_GENS</code> è¨ˆç®—å‡º gen</li><li>Gen åˆ†é¡: <code>max_seq</code> è¡¨ç¤ºæœ€å¹´è¼•çš„ genï¼Œ<code>min_seq</code> è¡¨ç¤ºæœ€è€çš„ gen<ul><li>youngtest gen: max_seq (æœ€å¹´è¼•ï¼Œç†±åº¦æœ€é«˜)</li><li>young gen: max_seq - 1</li><li>old gen: min_seq + 1</li><li>oldest gen: min_seq (æœ€è€çš„ï¼Œç†±åº¦æœ€ä½)</li></ul></li><li>Gen ç¶­è­·: å°æ–¼ <code>max_gen</code>ï¼Œanon page å’Œ file-backed è¦–ç‚ºç›¸åŒçš„ hot pageï¼Œä½†æ˜¯ anon page å’Œ file-backed æœƒåˆ†åˆ¥ç¶­è­· <code>min_seq</code></li></ul></li><li><p>Promote æ©Ÿåˆ¶èˆ‡ Demote æ©Ÿåˆ¶</p><ul><li>Promote: ç•¶ page è¢«å†æ¬¡å­˜å–æ™‚æœƒ Promote åˆ°æ–°çš„ gen</li><li>Demote: åœ¨ MGLRU ä¸­ä¸å­˜åœ¨é¡¯å¼ Demote çš„æ“ä½œï¼Œç•¶ <code>max_seq</code> å¢åŠ æ™‚ï¼Œæ²’æœ‰ Promote çš„ page ç›¸å°å¹´é½¡å°±å¢åŠ äº†ï¼Œé”åˆ°éš±å¼ Demote çš„æ•ˆæœã€‚</li><li>page æ²ˆé™: éš¨è‘—æ™‚é–“æ¨ç§»ï¼Œæ²’æœ‰ Promote çš„ page è‡ªç„¶è®Šæˆ oldest genï¼Œè®Šå¾—å¯èƒ½è¢«å›æ”¶çš„ pageã€‚ç•¶ oldest gen ä¸­çš„ page è¢«å…¨éƒ¨å›æ”¶ï¼ŒLRU list è¢«åˆªé™¤ä¸¦ä¸” <code>min_seq++</code>ï¼Œæ•´å€‹ windows å¾€å‰æ»‘å‹•</li><li>generation ä¸è¶³: ç•¶ generation æ•¸é‡ä¸è¶³æ™‚ï¼Œå‰‡æœƒå»ºç«‹æ–°çš„ generation ç¹¼çºŒå€åˆ† page çš„ç†±åº¦</li></ul></li><li><p>å±¤ç´š (Tier)
å®šç¾©: æ¯å€‹ page (folio) æ ¹æ“š (é€šé fd å­˜å–çš„æ¬¡æ•¸ï¼Œåƒæ˜¯ <code>write(), read()</code>) è¢«åˆ†é…åˆ°ä¸€å€‹ Tierï¼Œå‡è¨­ page é€šé fd å­˜å–çš„æ¬¡æ•¸ç‚º $N$ï¼Œå‰‡ $Tier = order_base_2(N)$ã€‚æ¯å€‹ Page ä½¿ç”¨é¡å¤– 2 bit å»ç´€éŒ„ä»–å€‘å±¬æ–¼çš„ Tierï¼ŒTier çš„æœ€å¤§å€¼ç‚º $MAX_NR_TIERS = 4$</p><ul><li>Tier = 0 -> N = 0,1</li><li>Tier = 1 -> N = 2,3</li><li>Tier = 2 -> N = 4,5,6,7</li><li>Tier = 3 -> N = 8+
(ä¸Šé¢é€™å€‹ä½¿ç”¨åœ–è¡¨é€²è¡Œè¡¨ç¤º)</li></ul></li><li><p>Refault ç‡çµ±è¨ˆ</p><ul><li>Refault å®šç¾©: æŸå€‹ page è¢«å›æ”¶å¾Œå†æ¬¡è¢«å­˜å– (è©² page é‡æ–°è¢«è¼‰å…¥åˆ°è¨˜æ†¶é«”) çš„æ¯”ç‡</li><li>Refault è³‡æ–™çµæ§‹: çµ±è¨ˆæ–¹å¼ç‚ºé€šé <code>lrugen->refaulted[hist][type][tier]</code> è¨˜éŒ„ä¸åŒä¸–ä»£ (<code>hist</code>)ï¼ŒPage é¡å‹ (<code>anon</code>/<code>file-backed</code>), Tier çš„ refault æ¬¡æ•¸ã€‚ä½¿ç”¨é€™å€‹é™£åˆ—ç´€éŒ„æ¯ä¸€å€‹ Tier çš„ refault ç‡ï¼Œä¹Ÿå°±æ˜¯é€™å€‹ Tier è¢«å›æ”¶çš„ page ä¹‹å¾Œåˆè¢«é‡æ–°è¼‰å…¥ (refault) çš„æ¯”ä¾‹ã€‚</li><li>Refault ç‡ = è¢«å›æ”¶åˆé‡æ–°è¼‰å…¥çš„ page æ•¸é‡ / è¢«å›æ”¶çš„ page æ•¸é‡</li><li>æ±ºç­–æ©Ÿåˆ¶:<ul><li>å…ˆæ¯”è¼ƒ <code>min_seq</code> çš„å€¼ï¼Œé¸æ“‡è¼ƒå°å€¼ï¼Œä¹Ÿå°±æ˜¯æ›´è€çš„ page é¡å‹</li><li>å¦‚æœå…©å€‹ page é¡å‹éƒ½ç›¸åŒï¼Œå‰‡æ¯”è¼ƒ Tier 0 çš„ refault ç‡ï¼Œé¸æ“‡æ¯”è¼ƒä½çš„ page é¡å‹é€²è¡Œå›æ”¶</li><li>ä½¿ç”¨ PID æ§åˆ¶å™¨çš„å›é¥‹æ©Ÿåˆ¶ï¼Œå‹•æ…‹å¹³è¡¡ä¸åŒ page é¡å‹çš„ refault ç‡</li></ul></li></ul></li></ul><p>ç¸½çµä¸€ä¸‹ï¼Œæ¯å€‹ page é€šéé¡å¤–çš„ flags ç´€éŒ„è‡ªå·±å±¬æ–¼çš„ Tierï¼Œç³»çµ±æœƒç¶­è­·é¡å¤–çš„ array å»ç´€éŒ„æ¯ä¸€å€‹ Tier çš„ refault ç‡ã€‚eviction ç­–ç•¥æœƒæ ¹æ“š refault å‹•æ…‹èª¿æ•´å›æ”¶çš„è¡Œç‚ºï¼Œé¿å…é »ç¹å­˜å–çš„ page ä½†æ˜¯æœªé”åˆ° Promote æ¨™æº–çš„ page è¢«éæ—©çš„å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ refault ç‡å¯ä»¥ç”¨ä¾†åˆ¤æ–·ç•¶å…©ç¨® page é¡å‹å¹´é½¡ç›¸åŒæ™‚ï¼Œrefault ç‡å¯ä»¥ç”¨ä¾†åˆ¤æ–·è¦å›æ”¶çš„ pageï¼Œæ›´åŠ ç²¾ç´°åŒ– page çš„åˆ†é¡ã€‚</p><p>ç”±ä¸Šé¢çš„æè¿°ï¼Œæˆ‘å€‘æœƒç™¼ç¾åˆ°ï¼Œç•¶æœ‰ä¸€å€‹ Page ä½æ–¼æœ€è€çš„ genï¼Œä½†æ˜¯ä»–çš„ refault ç‡é«˜ï¼Œé€™æ™‚å€™æˆ‘å€‘æ‡‰è©²æœ‰ä¸€å€‹æ©Ÿåˆ¶å°é€™é¡çš„ page é€²è¡Œè™•ç†ï¼Œé¿å…ä»–å€‘è¢«å›æ”¶ï¼Œå½±éŸ¿åˆ° working setï¼Œåœ¨ MGLRU ä¸­å­˜åœ¨ Protect æ©Ÿåˆ¶ç”¨ä¾†ä¿è­·é€™ä¸€äº› pageã€‚</p><ul><li>Protect æ©Ÿåˆ¶:<ul><li>ç•¶æŸå€‹ Tier çš„ Refault ç‡é«˜æ–¼ Tier 0 çš„ Refault ç‡ï¼Œå°‡æœƒè§¸ç™¼ Protect æ©Ÿåˆ¶</li><li>è§¸ç™¼ Protect æ©Ÿåˆ¶çš„ pageï¼Œæœƒè¢«ç§»å‹•åˆ° old gen <code>min_seq + 1</code>ï¼Œç›¸ç•¶æ–¼çµ¦é€™å€‹ page second chanceï¼Œé¿å…æ•´å€‹ oldest gen ä¸€æ¬¡è¢«å›æ”¶ä¹¾æ·¨ï¼Œé€ æˆéƒ¨ä»½ Trashing ç¾è±¡ç™¼ç”Ÿ</li><li>ç›®æ¨™ç‚ºäº†æé«˜ MGLRU å°æ–¼å¯†é›† I/O çš„ working set ä¿è­·æ•ˆæœ</li></ul></li></ul><p>ä»¥ä¸‹ç‚º mglru é—œéµè³‡æ–™çµæ§‹ç¨‹å¼ç¢¼</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>lru_gen_folio</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* the aging increments the youngest generation number */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>max_seq</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* the eviction increments the oldest generation numbers */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>min_seq</span><span class=p>[</span><span class=n>ANON_AND_FILE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* the birth time of each generation in jiffies */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>timestamps</span><span class=p>[</span><span class=n>MAX_NR_GENS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* the multi-gen LRU lists, lazily sorted on eviction */</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>list_head</span> <span class=n>folios</span><span class=p>[</span><span class=n>MAX_NR_GENS</span><span class=p>][</span><span class=n>ANON_AND_FILE</span><span class=p>][</span><span class=n>MAX_NR_ZONES</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span></code></pre></td></tr></table></div></div><p>å­˜æ”¾ page (folios) ç‚ºä¸€å€‹ä¸‰ç¶­é™£åˆ—çµæ§‹ï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹å¼é€²è¡Œæ‹†åˆ†</p><ul><li>ç¬¬ä¸€ç¶­åº¦: Generationï¼Œæœ€å¤š 4 å€‹ generation</li><li>ç¬¬äºŒç¶­åº¦: å±¬æ–¼ anon page é‚„æ˜¯ file-backed page</li><li>ç¬¬ä¸‰ç¶­åº¦: NUMA Nodeï¼Œå°æ–¼ UMA ç‚º 1</li></ul><p>è¨˜éŒ„ Refault ç‡çš„çµæ§‹ä¹ŸåŒæ¨£ä½æ–¼ lru_gen_folio ä¸­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>lru_gen_folio</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* the multi-gen LRU sizes, eventually consistent */</span>
</span></span><span class=line><span class=cl>	<span class=kt>long</span> <span class=n>nr_pages</span><span class=p>[</span><span class=n>MAX_NR_GENS</span><span class=p>][</span><span class=n>ANON_AND_FILE</span><span class=p>][</span><span class=n>MAX_NR_ZONES</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* the exponential moving average of refaulted */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>avg_refaulted</span><span class=p>[</span><span class=n>ANON_AND_FILE</span><span class=p>][</span><span class=n>MAX_NR_TIERS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* the exponential moving average of evicted+protected */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>avg_total</span><span class=p>[</span><span class=n>ANON_AND_FILE</span><span class=p>][</span><span class=n>MAX_NR_TIERS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* can only be modified under the LRU lock */</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>protected</span><span class=p>[</span><span class=n>NR_HIST_GENS</span><span class=p>][</span><span class=n>ANON_AND_FILE</span><span class=p>][</span><span class=n>MAX_NR_TIERS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* can be modified without holding the LRU lock */</span>
</span></span><span class=line><span class=cl>	<span class=kt>atomic_long_t</span> <span class=n>evicted</span><span class=p>[</span><span class=n>NR_HIST_GENS</span><span class=p>][</span><span class=n>ANON_AND_FILE</span><span class=p>][</span><span class=n>MAX_NR_TIERS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=kt>atomic_long_t</span> <span class=n>refaulted</span><span class=p>[</span><span class=n>NR_HIST_GENS</span><span class=p>][</span><span class=n>ANON_AND_FILE</span><span class=p>][</span><span class=n>MAX_NR_TIERS</span><span class=p>];</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸‹åœ–ç°¡å–®æè¿° gen, tier ä¹‹é–“çš„é—œä¿‚
<img src=https://hackmd.io/_uploads/SkA9-sdgge.png loading=lazy alt=image></p><p>ä¸‹çªåœ Protect èˆ‡ Promote ä¹‹é–“çš„é—œä¿‚
<img src=https://hackmd.io/_uploads/BkZAbo_lge.png loading=lazy alt=image></p><h3 id=è·¯å¾‘1-aging-æ©Ÿåˆ¶>è·¯å¾‘1. Aging æ©Ÿåˆ¶</h3><p>æ‰€è¬‚ Agingï¼ŒæŒ‡çš„æ˜¯é€šéå»ºç«‹æ–°çš„ gen æé«˜ page ç†±åº¦åˆ¤æ–·çš„æ©Ÿåˆ¶ã€‚åœ¨ kernel å›æ”¶ page çš„æ™‚å€™ï¼Œç•¶ç™¼ç¾ç¾æœ‰çš„ gen æ•¸é‡ä¸è¶³ä»¥å€åˆ† hot/cold page æ™‚ï¼Œé€™æ™‚å¾Œæœƒè§¸ç™¼ Aging æ“ä½œï¼ŒAging æ“ä½œæœƒæ–°å¢ä¸€å€‹ genã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>kswapd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=err>â””â”€</span> <span class=nf>balance_pgdat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=err>â””â”€</span> <span class=nf>shrink_node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=err>â””â”€</span> <span class=nf>shrink_one</span><span class=p>()</span>
</span></span><span class=line><span class=cl>              <span class=err>â””â”€</span> <span class=nf>try_to_shrink_lruvec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                  <span class=err>â””â”€</span> <span class=nf>lru_gen_shrink_lruvec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                      <span class=err>â””â”€</span> <span class=nf>should_run_aging</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                          <span class=err>â””â”€</span> <span class=nf>try_to_inc_max_seq</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                              <span class=err>â””â”€</span> <span class=nf>lru_gen_age_node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                                  <span class=err>â””â”€</span> <span class=nf>walk_page_range</span> <span class=p>(</span><span class=k>for</span> <span class=n>each</span> <span class=n>mm_struct</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                      <span class=err>â””â”€</span> <span class=nf>folio_update_gen</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>å•Ÿå‹• Aging å¾Œï¼ŒMGLRU æœƒé€šé Page Table Walker æ›´æ–° page çš„ç†±åº¦ï¼Œæ¥è‘—å°æ–¼ç›®å‰è¨˜æ†¶é«”ä¸­æ¯å€‹ process/mm_structï¼Œæœƒå‘¼å« <code>walk_page_range()</code> éæ­·å…¶ Page Tableï¼Œä»¥æ‰¾åˆ°å¹´è¼•çš„ page (PTE çš„ Accessed bit ç‚º 1 çš„)ã€‚ç‚ºäº†é™ä½é–‹éŠ·ï¼Œéæ­·ä¹‹å‰æœƒå…ˆæŸ¥è©¢ Bloom Filter æ‰¾åˆ°å€¼å¾—æƒæçš„ Page å€åŸŸ (ä¾‹å¦‚åŒ…å«å¤šå€‹ hot page çš„ PMD)ã€‚åœ¨éæ­·éç¨‹ä¸­ï¼Œå¦‚æœç™¼ç¾é€™å€‹ç¯„åœå…§å­˜åœ¨ Access Bit ç‚º 1 çš„ PTEï¼Œè¡¨ç¤ºè©² page è¿‘æœŸæœ‰è¢«å­˜å–éï¼Œå±¬æ–¼æ½›åœ¨çš„ hot pageï¼Œé€™æ™‚å¾Œæœƒé€šé <code>folio_update_gen()</code> æ¨™è¨˜è©² page promote åˆ°æœ€æ–°çš„ genï¼Œä¹Ÿå°±æ˜¯å°‡è©² page çš„ generation æ›´æ–°æˆ <code>max_seq</code>ï¼Œè€Œ promote æ“ä½œæ˜¯åªå»ä¿®æ”¹ page çš„ gen æ¨™è¨˜ï¼Œä¸æ˜¯ç«‹å³ç§»å‹•è©² page åœ¨ LRU list ä¸­çš„ä½ç½®ï¼Œç›´åˆ°çœŸæ­£ evict çš„æ™‚å€™æ‰æœƒé€²è¡Œç§»å‹•</p><p>ç•¶ä¸€è¼ª Aging çš„æ“ä½œçµæŸï¼Œæ–°çš„ gen ç”¢ç”Ÿï¼Œé€™æ™‚å€™ <code>max_seq + 1</code>ï¼Œä¸¦ç´€éŒ„ç›®å‰çš„ timestampã€‚MGLRU éš¨å¾Œæœƒä½¿ç”¨è©² timestamp å¯¦ç¾ Thrashing é˜²è­·ï¼Œå¦‚æœä¹‹å¾Œå˜—è©¦å›æ”¶ <code>min_seq</code> è£¡é¢çš„ pageï¼Œç™¼ç¾åˆ° <code>min_seq</code> çš„ç”¢ç”Ÿæ™‚é–“é‚„æ²’è¶…éé è¨­çš„ TTL é–¥å€¼ï¼Œå‰‡æœƒæš«ç·©å›æ”¶è©² genã€‚é€™å€‹æ©Ÿåˆ¶é¿å…ç³»çµ±é »ç¹çš„å›æ”¶/å»ºç«‹ genï¼Œé˜²æ­¢ working set å› ç‚ºé »ç¹çš„åœ¨ gen ä¹‹é–“ç§»å‹•é€ æˆ Thrashingã€‚</p><p>å®Œæˆ Aging ä¹‹å¾Œï¼ŒMGLRU æœƒç¹¼çºŒé€²è¡Œ page evict çš„æµç¨‹ï¼Œä¸æ–·å¾ªç’°çš„åŸ·è¡Œ Promote / Evict / Aging çš„æµç¨‹ï¼Œä½¿å¾— hot page ä¿ç•™åœ¨æœ€æ–°çš„ genï¼Œcold page æ²ˆç©åˆ°æœ€è€çš„ genã€‚åœ¨ä»»ä½•æ™‚åˆ»ï¼ŒMGLRU æœ€å¤šä¿æŒ 4 å€‹ genï¼Œé€™ä¸€ä»¶äº‹æƒ…æ˜¯é€šé sliding windows (<code>4 >= max_seq - min_seq >= 2</code>) ä¿è­‰ã€‚</p><p>ä»¥ call chain é€²è¡Œåˆ†æï¼Œå‰‡å¯ä»¥å¾—åˆ°ä»¥ä¸‹</p><p>è¨˜æ†¶é«”é«˜å£“ï¼Œéœ€è¦å°‡ page swapoutï¼Œé€™æ™‚å€™ kswapd è¢«å–šé†’ï¼Œæ¥è‘—åŸ·è¡Œ <code>shrink_node()</code> -> <code>shrink_lruvec()</code> -> <code>lru_gen_shrink_lruvec</code> -> <code>should_run_aging</code> -> <code>try_to_inc_max_seq()</code> åŸ·è¡Œä¸»è¦çš„ Aging -> å…§éƒ¨å°æ¯å€‹ memcg çš„ <code>mm_list</code> å‘¼å« <code>walk_page_range()</code> éæ­· Page Tableï¼Œåœ¨ callback ä¸­å°éæ­· Page Table éç¨‹ä¸­ç™¼ç¾çš„ young page (PTE ç‚º 1) çš„ page å‘¼å« <code>folio_update_gen()</code> Promote è©² page çš„ genï¼ŒåŒæ™‚å°‡è³‡è¨Šå›é¥‹åˆ° Bloom Filter å„ªåŒ–å€¼å¾—èµ°è¨ªçš„è¨˜æ†¶é«”å€åŸŸï¼Œå…¨éƒ¨å®Œæˆä¹‹å¾Œæº–å‚™é€²è¡Œ Eviction</p><p>æ•´é«”æµç¨‹ç‚ºä»¥ä¸‹
<img src=https://hackmd.io/_uploads/r1GJMsdglg.png width=350></p><h3 id=è·¯å¾‘2-evict>è·¯å¾‘2. Evict</h3><p>:::info
é—œæ–¼ <code>walk_page_range()</code> èˆ‡ rmap çš„å·®åˆ¥</p><p>:::</p><p>Eviction æµç¨‹æŒ‡çš„æ˜¯å¾ <code>min_seq</code> é–‹å§‹æ·˜æ±° page çš„æ©Ÿåˆ¶ã€‚åœ¨ MGLRU ä¸­ï¼Œå§‹çµ‚åªå›æ”¶ç›®å‰ <code>min_seq</code> LRU list ä¸­çš„ pageã€‚ç•¶è§¸ç™¼ kswapd æ™‚ï¼Œkernel æœƒé¸æ“‡ <code>min_seq</code> é€²è¡Œæƒæä»¥åŠå›æ”¶ã€‚ç”±æ–¼ MGLRU æœƒå°‡ hot page é€šé Aging æ©Ÿåˆ¶å°‡ hot page Promote åˆ° <code>max_seq</code>ï¼Œè‡ªç„¶è€Œç„¶ç›¸å° cold page å°±æœƒæ²ˆé™åˆ° <code>min_seq</code>ï¼Œ<code>min_seq</code> è£¡é¢çš„ page ç‚ºé•·æ™‚é–“æ²’æœ‰å­˜å–çš„ pageï¼Œå¯ä½œç‚ºå›æ”¶çš„ç›®æ¨™ã€‚å°æ–¼ <code>min_seq</code>ï¼ŒMGLRU æœƒåˆ†åˆ¥ç¶­è­· anon page å’Œ file-backed page å…©å€‹ listï¼Œå› æ­¤å¯èƒ½å­˜åœ¨ anon page å’Œ file-backed page å…©è€… <code>min_seq</code> ä¸åŒæ­¥çš„æƒ…æ³ã€‚</p><p>ä»¥ä¸‹ç‚º Eviction çš„ call chain</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>kswapd</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=err>â””â”€</span> <span class=nf>balance_pgdat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=err>â””â”€</span> <span class=nf>shrink_node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=err>â””â”€</span> <span class=nf>shrink_one</span><span class=p>()</span>
</span></span><span class=line><span class=cl>              <span class=err>â””â”€</span> <span class=nf>try_to_shrink_lruvec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                  <span class=err>â””â”€</span> <span class=nf>evict_folios</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                      <span class=err>â”œâ”€</span> <span class=nf>isolate_folios</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                      <span class=err>â”‚</span>    <span class=err>â””â”€</span> <span class=nf>scan_folios</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                      <span class=err>â”‚</span>         <span class=err>â”œâ”€</span> <span class=nf>sort_folio</span><span class=p>()</span>     <span class=c1>// Promote ç†±é åˆ°æ¬¡è€ä¸–ä»£
</span></span></span><span class=line><span class=cl><span class=c1></span>                      <span class=err>â”‚</span>         <span class=err>â””â”€</span> <span class=nf>isolate_folio</span><span class=p>()</span>  <span class=c1>// é¸å‡º page
</span></span></span><span class=line><span class=cl><span class=c1></span>                      <span class=err>â”œâ”€</span> <span class=nf>shrink_page_list</span><span class=p>()</span>         <span class=c1>// å°é¸å‡ºçš„ page é€²è¡Œå¯¦éš›å›æ”¶
</span></span></span><span class=line><span class=cl><span class=c1></span>                      <span class=err>â”‚</span>    <span class=err>â”œâ”€</span> <span class=nf>folio_check_references</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                      <span class=err>â”‚</span>    <span class=err>â”‚</span>    <span class=err>â””â”€</span> <span class=nf>folio_referenced</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                      <span class=err>â”‚</span>    <span class=err>â”‚</span>         <span class=err>â””â”€</span> <span class=nf>lru_gen_look_around</span><span class=p>()</span> <span class=c1>// å±€éƒ¨æ€§å„ªåŒ–ï¼Œå°‹æ‰¾é™„è¿‘çš„ hot PTE
</span></span></span><span class=line><span class=cl><span class=c1></span>                      <span class=err>â”‚</span>    <span class=err>â”œâ”€</span> <span class=nf>lru_gen_set_refs</span><span class=p>()</span>    <span class=c1>// æ±ºå®šæ˜¯å¦ Protectï¼ˆç§»å‹•åˆ° min_seq+1ï¼‰
</span></span></span><span class=line><span class=cl><span class=c1></span>                      <span class=err>â”‚</span>    <span class=err>â””â”€</span> <span class=nf>try_to_free_swap</span><span class=p>()</span> <span class=o>/</span> <span class=nf>folio_free</span><span class=p>()</span> <span class=c1>// swap out æˆ–é‡‹æ”¾
</span></span></span><span class=line><span class=cl><span class=c1></span>                      <span class=err>â””â”€</span> <span class=nf>try_to_inc_min_seq</span><span class=p>()</span>       <span class=c1>// è‹¥ oldest gen å·²æ¸…ç©ºå‰‡æ·˜æ±°ä¸¦ min_seq++
</span></span></span></code></pre></td></tr></table></div></div><p>é€²å…¥ Eviction æµç¨‹å¾Œï¼Œé—œéµå‡½å¼ <code>lru_gen_shrink_lruvec()</code> æŒ‰ç…§ä¸€å®šç­–ç•¥å¾ <code>min_gen</code> list æå– page é€²è¡Œè™•ç†ã€‚æ¯æ¬¡æå–ä¸€æ‰¹ page å¾Œï¼Œæœƒå°é€™ä¸€äº› page é€ä¸€é€²è¡Œå›æ”¶åˆ¤æ–·ã€‚å°æ¯å€‹ page (<code>struct folio</code>)ï¼Œé¦–å…ˆå‘¼å« <code>folio_check_references()</code> æª¢æŸ¥æœ€è¿‘æ˜¯å¦è¢«å¼•ç”¨æˆ–æ˜¯å±¬æ–¼ working set çš„ pageï¼Œ<code>folio_check_references()</code> æœƒé€²ä¸€æ­¥å‘¼å« <code>folio_referenced()</code> åŸ·è¡Œ Rmap èµ°è¨ªï¼ŒæŸ¥è©¢è©² page æ˜ å°„çš„æ‰€æœ‰ PTEï¼Œçµ±è¨ˆè©² page çš„å¼•ç”¨æƒ…æ³ã€‚</p><p>é—œæ–¼ <code>folio_referenced</code> çš„å¯¦ç¾é‹ç”¨åˆ°ç©ºé–“å±€éƒ¨æ€§é€²è¡Œå„ªåŒ–ï¼Œç•¶é€šé Rmap æ‰¾åˆ°æŸå€‹ process çš„ PTE å€¼ï¼ŒMGLRU æœƒå‘¼å« <code>lru_gen_look_around</code> æŸ¥çœ‹è©² PTE ç›¸é„°çš„å¤šå€‹ PTEï¼Œå¦‚æœé™„è¿‘çš„ PTE ä¹Ÿå±¬æ–¼å¹´è¼•çš„ (ä¹Ÿå°±æ˜¯ Access Bit ç‚º 1)ï¼Œå‰‡é€™ä¸€äº› page æœƒè¢«æ¨™è¨˜ç‚º Promoteï¼Œä¹‹å¾Œä¾¿æœƒçœŸæ­£ Promote åˆ° <code>max_seq</code>ã€‚åˆ©ç”¨ Look-around æ©Ÿåˆ¶ï¼ŒMGLRU å¯ä»¥åœ¨ä¸€æ¬¡ Rmap ä¸­æ‰¾åˆ°å¤šå€‹ hot pageï¼Œæ¸›å°‘é‡è¤‡éæ­· Page Table çš„é–‹éŠ·ï¼Œä¸¦ä¸”é€™äº› PTE å°æ‡‰åˆ°çš„ä¸Šå±¤ Page Table ç¯€é»ï¼Œä¹Ÿå°±æ˜¯ PMD æœƒè¢«ç´€éŒ„åˆ° Bloom Filter ä¸­ï¼Œåšç‚ºä¹‹å¾Œ Aging éšæ®µçš„è¼”åŠ©åˆ¤æ–·è³‡è¨Š</p><p>å°æ–¼æ¯å€‹å¾ <code>min_seq</code> æå–çš„ pageï¼Œ<code>folio_check_references</code> æœƒæ ¹æ“š rmap çš„çµæœå›å‚³ enumï¼Œè©² enum çš„æ„ç¾©æ˜¯å° page eviction çš„å»ºè­°</p><ul><li><code>FOLIOREF_RECLAIM</code>: page æœ€è¿‘æ²’æœ‰è¢« referenceï¼Œå¯ä»¥å›æ”¶</li><li><code>FOLIOREF_ACTIVATE</code>: page æœ€è¿‘è¢« referenceï¼Œæ‡‰è©² Promote ä¸¦ä¿ç•™</li><li><code>FOLIOREF_KEEP</code>: æš«æ™‚ä¸è™•ç† (å¯èƒ½æ­£åœ¨è¢«å…¶ä»–ç¨‹å¼ä½¿ç”¨æˆ– lock)</li></ul><p>å¦‚æœ page æœ€è¿‘æ²’æœ‰ä»»ä½•å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯ <code>referenced_ptes</code> ç‚º 0ï¼Œå‰‡å±¬æ–¼çœŸæ­£çš„ cold pageï¼Œå°‡æŒ‰ç…§è©² page å±¬æ–¼çš„é¡å‹é€²è¡Œ direct reclaimã€‚å±¬æ–¼ file-backed page æœƒç›´æ¥å›æ”¶æˆ–æ˜¯ write-back åˆ°ç¡¬ç¢Ÿï¼Œè€Œå¦‚æœå±¬æ–¼ anon page å‰‡æœƒ swap å‡ºå»ã€‚</p><p>å¦‚æœ page æœ€è¿‘æœ‰ä½¿ç”¨ï¼Œå‰‡ MGLRU æœƒçµ¦è©² page ç¬¬äºŒåˆºæ¿€æœƒï¼Œ<code>folio_check_references()</code> é€šé <code>lru_gen_set_refs()</code> å‡½å¼åˆ¤æ–·æ˜¯å¦éœ€è¦ promote è©² pageï¼Œé€™è£¡å…·é«”ç‚ºä½¿ç”¨ Tier å»åˆ¤æ–·è©² page æ˜¯å¦æœ€è¿‘è¢«ä½¿ç”¨éä»¥åŠæ˜¯å¦å±¬æ–¼ working set (ä¹Ÿå°±æ˜¯è¢« evict ä¹‹å¾Œåˆé‡æ–°è¼‰å…¥çš„ pageï¼Œrefault çš„æ¦‚å¿µ)</p><ul><li>ç¬¬ä¸€æ¬¡ç™¼ç¾å¼•ç”¨: å¦‚æœ page æ­¤å‰æ²’æœ‰æ¨™è¨˜ Referenced ä¹Ÿä¸æ˜¯å±¬æ–¼ working set çš„ pageï¼Œ<code>lru_gen_set_refs()</code> å°‡è©² page æ¨™è¨˜ç‚º referenced (è¨­ç½® <code>PG_referenced</code> Flag)ï¼Œæ¥è‘—å›å‚³ falseï¼Œæ„ç¾©ç‚ºè©² page æš«æ™‚ä¸åš Promoteã€‚æ•´å€‹æ„ç¾©æ˜¯ç´€éŒ„è©² page å¼•ç”¨äº†ä¸€æ¬¡ï¼Œçµ¦ page ä¸€æ¬¡æ©Ÿæœƒç•™åœ¨ç›®å‰çš„ genï¼Œä¸‹ä¸€æ¬¡å†é‡åˆ°è©² page çš„æ™‚å€™å†åšæ±ºå®š</li><li>å†æ¬¡è¢«å¼•ç”¨æˆ–æ˜¯æ›¾ç¶“è¢« refault: å¦‚æœ page å·²ç¶“æœ‰ referenced æ¨™è¨˜æˆ–è€…å…¶ <code>PG_workingset</code> Flag ç‚º True (è¡¨ç¤ºè©² page æ›¾ç¶“ refault éï¼Œå±¬æ–¼ working set çš„ä¸€éƒ¨åˆ†)ï¼Œé‚£éº¼ <code>lru_gen_set_refs</code> æœƒå›å‚³ Trueï¼Œè¡¨ç¤ºè©² page éœ€è¦é€²è¡Œ Promoteã€‚é€™æ™‚å€™ <code>folio_check_references()</code> æœƒå›å‚³ <code>FOLIOREF_ACTIVATE</code>ï¼Œkernel æœƒå°‡è©² page å¾ <code>min_seq</code> ç§»é™¤ä¸¦é‡æ–°åŠ å…¥åˆ° <code>max_seq</code>ï¼Œå¯¦ä½œç‚ºç§»å‹•åˆ° generation æœ€é«˜çš„ listï¼Œé¿å…é€™æ¬¡è¢«å›æ”¶ï¼Œé€™å€‹æå‡ page çš„æ“ä½œä¹Ÿç¨±ç‚ºå°è©² page çš„ Protect</li></ul><p>ä¸Šé¢çš„ç­–ç•¥ï¼ŒMGLRU ç¢ºä¿ä¸€å€‹ page è¦è¢« Protectï¼Œä¹Ÿå°±æ˜¯ page è¢« Promote éœ€è¦ç¬¦åˆä»¥ä¸‹ä¸€å€‹æ¢ä»¶</p><ul><li>Page è¢«å­˜å–å…©æ¬¡</li><li>è©² Page å±¬æ–¼ working set
é€šéä»¥ä¸Šç­–ç•¥é¿å…ä¸€äº› page å› ç‚ºä¸€æ¬¡å¶ç„¶çš„å­˜å–å°±é˜»æ­¢è©² page è¢«å›æ”¶ã€‚è€Œå°æ–¼ç¢ºå¯¦ç¶“å¸¸è¢«å­˜å–çš„ pageï¼ŒMGLRU æœƒå°è©² page é€²è¡Œ Protect é¿å…å…¶è¢«æ·˜æ±°</li></ul><p>éš¨è‘— eviction æ©Ÿåˆ¶é€²è¡Œï¼Œ<code>min_seq</code> è£¡é¢çš„ page ä¸æ˜¯è¢«å›æ”¶é‡‹æ”¾ï¼Œä¸ç„¶å°±æ˜¯å› ç‚ºä»–æœ‰å¼•ç”¨è€Œè¢«ç§»é™¤ <code>min_seq</code>åŠ å…¥åˆ° <code>max_seq</code>ã€‚Kernel æœƒæŒçºŒé€²è¡Œä¸Šé¢çš„æ“ä½œï¼Œç›´åˆ° gen è£¡é¢æ‰€æœ‰ page è™•ç†å®Œç•¢ï¼Œæ¥è‘—è©² gen å°±æœƒè¢«ä¸Ÿæ£„ï¼Œå°‡ <code>min_seq + 1</code> (æ·˜æ±°æœ€è€çš„ gen)ï¼Œé€™éƒ¨ä»½ç”± <code>inc_min_seq()</code> å®Œæˆï¼Œè² è²¬æ›´æ–° anon page å’Œ filed-back page å°æ‡‰çš„ oldest gen seq ä¸¦æ¸…ç†ç›¸é—œè³‡æ–™çµæ§‹ã€‚ä¸Ÿæ£„ gen çš„åŒæ™‚ï¼Œkernel æœƒå»ç¶­è­·ä¸€äº›è¼”åŠ©è³‡æ–™çµæ§‹ï¼Œåƒæ˜¯è©² gen ä¸­è¢«å›æ”¶çš„ page æ•¸é‡ï¼Œå„ Tier è¢«å›æ”¶å’Œ refault æ¬¡æ•¸ç­‰ç­‰ï¼Œç‰¹åˆ¥æœƒé‡å°å‰›å‰›åœ¨å›æ”¶æˆ–æˆå› ç‚º refault ç‡é«˜è€Œè¢« Protect çš„ page è³‡è¨Šä¹Ÿæœƒè¢«è¨˜éŒ„ä¸‹ä¾†ï¼Œç´å…¥æ­·å²çµ±è¨ˆä¸­ï¼Œç”¨æ–¼èª¿æ•´å¾ŒçºŒçš„ eviction ç­–ç•¥ã€‚å®Œæˆä¸€å€‹ gen å›æ”¶å¾Œï¼Œå¦‚æœè¨˜æ†¶é«”å£“åŠ›æ²’æœ‰ç´“è§£ä¸¦ä¸”éœ€è¦é‡‹æ”¾æ›´å¤šè¨˜æ†¶é«”ï¼ŒMGLRU æœƒç¹¼çºŒé‡è¤‡ä¸Šé¢ Aging + Eviction éç¨‹</p><p>ä»¥ call chain é€²è¡Œåˆ†æå¦‚ä¸‹
<code>lru_gen_shrink_lruvec()</code> -> å¾ <code>min_seq</code> list ä¸­æå– page é€²è¡Œè™•ç† -> å°æ¯å€‹ page å‘¼å« <code>folio_check_references()</code> æª¢æŸ¥æ˜¯å¦è¢«å¼•ç”¨ -> <code>folio_eferenced()</code> åŸ·è¡Œ rmap æŸ¥è©¢ Access Bit (è£¡é¢å‘¼å« <code>lru_gen_look_around</code>) æª¢æŸ¥é„°è¿‘ PTE ä¸¦æ¨™è¨˜ hot pageï¼Œæ›´æ–° Bloom Filter) -> æ ¹æ“š <code>folio_check_references</code> å›å‚³çš„ enum æ±ºå®š folio æ‡‰è©²å¦‚ä½•è™•ç†ï¼Œæ²’æœ‰å¼•ç”¨çš„é€²è¡Œå›æ”¶ (å‘¼å« <code>try_to_free_swap</code> æˆ– <code>folio_free</code> é‡‹æ”¾)ï¼Œå¦‚æœæœ‰å¼•ç”¨å‰‡å‘¼å« <code>lru_gen_set_refs</code> åˆ¤æ–·æ˜¯å¦æ‡‰è©² Promote (é€²è¡Œ Protect) -> å¦‚æœéœ€è¦ Promote å‰‡å°‡è©² page åŠ å…¥åˆ° <code>max_seq</code> -> ç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹ pageï¼Œç›´åˆ°æå–å‡ºçš„ page éƒ½è¢«æƒæå®Œç•¢ -> è™•ç†å®Œç•¢å¾Œå‘¼å« <code>inc_min_seq</code> å°‡è©² gen ä¸Ÿæ£„ï¼Œä¸¦å°‡ <code>min_seq + 1</code></p><p>æ•´é«”æµç¨‹ç‚ºä»¥ä¸‹
<img src=https://hackmd.io/_uploads/SyqGGj_exl.png width=500></p><p>æ•´å€‹ Eviction å’Œ Aging å’Œ Promote è¡Œç‚ºä¸€å€‹å¾ªç’°åœ–ï¼Œå¯ä»¥è¡¨ç¤ºæˆä»¥ä¸‹
<img src=https://hackmd.io/_uploads/ByJLfjuglg.png loading=lazy alt=image></p><h4 id=é—œéµå‡½å¼-try_to_shrink_lruvec-åˆ†æ>é—œéµå‡½å¼ <code>try_to_shrink_lruvec</code> åˆ†æ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>bool</span> <span class=nf>try_to_shrink_lruvec</span><span class=p>(</span><span class=k>struct</span> <span class=n>lruvec</span> <span class=o>*</span><span class=n>lruvec</span><span class=p>,</span> <span class=k>struct</span> <span class=n>scan_control</span> <span class=o>*</span><span class=n>sc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>long</span> <span class=n>nr_to_scan</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>scanned</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>swappiness</span> <span class=o>=</span> <span class=nf>get_swappiness</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>delta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>nr_to_scan</span> <span class=o>=</span> <span class=nf>get_nr_to_scan</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>,</span> <span class=n>swappiness</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>nr_to_scan</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>delta</span> <span class=o>=</span> <span class=nf>evict_folios</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>,</span> <span class=n>swappiness</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>scanned</span> <span class=o>+=</span> <span class=n>delta</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>scanned</span> <span class=o>&gt;=</span> <span class=n>nr_to_scan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nf>should_abort_scan</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nf>cond_resched</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	 * If too many file cache in the coldest generation can&#39;t be evicted
</span></span></span><span class=line><span class=cl><span class=cm>	 * due to being dirty, wake up the flusher.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>sc</span><span class=o>-&gt;</span><span class=n>nr</span><span class=p>.</span><span class=n>unqueued_dirty</span> <span class=o>&amp;&amp;</span> <span class=n>sc</span><span class=o>-&gt;</span><span class=n>nr</span><span class=p>.</span><span class=n>unqueued_dirty</span> <span class=o>==</span> <span class=n>sc</span><span class=o>-&gt;</span><span class=n>nr</span><span class=p>.</span><span class=n>file_taken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>wakeup_flusher_threads</span><span class=p>(</span><span class=n>WB_REASON_VMSCAN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* whether this lruvec should be rotated */</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>nr_to_scan</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢ç‚º MGLRU ä¸­é—œéµçš„ç¨‹å¼ç¢¼ï¼Œé€™æ˜¯ Memory Reclaim æµç¨‹ä¸­çœŸæ­£è¦æ·˜æ±° page çš„åœ°æ–¹</p><p>æ•´å€‹å‡½å¼å¯ä»¥åˆ†æˆä»¥ä¸‹éƒ¨ä»½</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>swappiness</span> <span class=o>=</span> <span class=nf>get_swappiness</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>é¦–å…ˆå–å¾— <code>swappiness</code><ul><li><code>swappiness</code> æ§åˆ¶è¦å›æ”¶çš„ page å‚¾å‘ï¼Œæ˜¯è¦å‚¾å‘æ–¼ anon page é‚„æ˜¯ file-backed page</li><li>å¦‚æœ <code>swappiness</code> åé«˜ï¼Œè¡¨ç¤ºæ›´å‚¾å‘æ–¼å›æ”¶ anon pageï¼Œåä¹‹å‰‡ file-backed pageã€‚é€™å€‹å€¼æœƒåœ¨ <code>get_nr_to_scan</code> å’Œ <code>evict_folios</code> ä¸­ä½¿ç”¨ï¼Œä»–å€‘æœƒæ ¹æ“š <code>swappiness</code> æ±ºå®šè¦è™•ç†çš„ page é¡å‹</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>nr_to_scan</span> <span class=o>=</span> <span class=nf>get_nr_to_scan</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>,</span> <span class=n>swappiness</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>nr_to_scan</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>æ¥è‘—é€²å…¥ä¸»è¦å›æ”¶è¿´åœˆï¼Œå…ˆè¨ˆç®—è¦æƒæçš„ page æ•¸é‡<ul><li><code>get_nr_to_scan()</code> æ ¹æ“šç›®å‰çš„ memory pressure å’Œ generation çµæ§‹è¨ˆç®—ç›®å‰éœ€è¦æƒæ</li><li>å¦‚æœç™¼ç¾çµæœ &lt;= 0ï¼Œè¡¨ç¤ºæ­¤ lruvec ä¸éœ€è¦æƒæ</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>delta</span> <span class=o>=</span> <span class=nf>evict_folios</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>,</span> <span class=n>swappiness</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>delta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>é€™è£¡æ˜¯ä¸»è¦åšå›æ”¶çš„åœ°æ–¹<ul><li><code>evict_folios()</code> æ˜¯å¯¦éš›æƒæä¸¦å˜—è©¦å›æ”¶æŸä¸€å±¤ generation ä¸­çš„ page (folios) çš„å‡½å¼</li><li><code>delta</code> è¡¨ç¤ºé€™æ¬¡æˆåŠŸè™•ç† (åŒ…å« reclaim ä»¥åŠ skip) çš„ page æ•¸é‡</li><li>å¦‚æœ <code>delta == 0</code>ï¼Œè¡¨ç¤ºé€™ä¸€å±¤ generation æ²’æœ‰å¯ä»¥å›æ”¶çš„ pageï¼Œè·³å‡ºè¿´åœˆ</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>scanned</span> <span class=o>+=</span> <span class=n>delta</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>scanned</span> <span class=o>&gt;=</span> <span class=n>nr_to_scan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>è¨ˆç®—å·²ç¶“æƒæçš„ page æ•¸é‡ä¸¦ç¢ºèªæ˜¯å¦é”æ¨™<ul><li>é€šé <code>scanned</code> å»ç´¯åŠ é€™æ¬¡ç¸½å…±æƒæäº†å¤šå°‘ page</li><li>å¦‚æœå·²ç¶“é”åˆ°é ä¼°å¾—æƒææ•¸é‡ <code>nr_to_scan</code>ï¼Œå‰‡é€€å‡º</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nf>should_abort_scan</span><span class=p>(</span><span class=n>lruvec</span><span class=p>,</span> <span class=n>sc</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>æª¢æŸ¥æ˜¯å¦è©²ä¸­æ­¢å›æ”¶è¡Œç‚º<ul><li>å…§éƒ¨æ¢ä»¶åˆ¤æ–·æ˜¯å¦è¦ä¸­æ­¢ï¼Œä¾‹å¦‚ memory pressure æ¸›ç·©ï¼Œæˆ– CPU è¦†è¼‰éé«˜</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>cond_resched</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>è®“å‡º CPU é¿å… starvation<ul><li><code>cond_resched()</code> å…è¨± scheduler åœ¨é€™å€‹é»åš context switchï¼Œé¿å…ç›®å‰é€™å€‹å‡½å¼é•·æ™‚é–“ä½”ç”¨ CPU</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>sc</span><span class=o>-&gt;</span><span class=n>nr</span><span class=p>.</span><span class=n>unqueued_dirty</span> <span class=o>&amp;&amp;</span> <span class=n>sc</span><span class=o>-&gt;</span><span class=n>nr</span><span class=p>.</span><span class=n>unqueued_dirty</span> <span class=o>==</span> <span class=n>sc</span><span class=o>-&gt;</span><span class=n>nr</span><span class=p>.</span><span class=n>file_taken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>wakeup_flusher_threads</span><span class=p>(</span><span class=n>WB_REASON_VMSCAN</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>è™•ç† dirty page çš„ç‹€æ³<ul><li>å¦‚æœæƒæåˆ°å¾ˆå¤š page éƒ½å±¬æ–¼ dirty file-backed pageï¼Œä¸”éƒ½æ²’æœ‰é€²å…¥åˆ° flusher queueï¼Œå°±æœƒ wake up flusher thread</li><li>é¿å… dirty page å¡åœ¨å›æ”¶éç¨‹ä¸­</li></ul></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>return</span> <span class=n>nr_to_scan</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>return ä¸¦ç”±ä¸Šå±¤ caller åˆ¤æ–·æ˜¯å¦éœ€è¦é€²è¡Œ rotate<ul><li>å¦‚æœ <code>nr_to_scan &lt; 0</code>ï¼Œè¡¨ç¤ºæŸäº› generation æƒæå®Œç•¢ï¼Œæ‡‰è©²æº–å‚™ rotate åˆ°ä¸‹ä¸€å€‹ generation</li><li>é€™å€‹å€¼æœƒå›å‚³åˆ°ä¸Šå±¤å¦‚ <code>shrink_one()</code> æ±ºå®šæ˜¯å¦é€²è¡Œ</li></ul></li></ul><p><code>try_to_shrink_lruvec()</code></p><ul><li>çœŸæ­£åŸ·è¡Œ LRU page reclaim çš„å‡½å¼ï¼Œå‡½å¼ç›®æ¨™ç‚ºæ˜¯å°æŸå€‹ memory cgroup çš„æŸå€‹ <code>lruvec</code>ã€€å˜—è©¦åŸ·è¡Œ MGLRU çš„å›æ”¶é‚è¼¯</li><li>caller æœƒæ ¹æ“šç›®å‰çš„ memory pressure æ±ºå®šè¦å»å“ªä¸€å€‹ generation åš reclaim</li><li>MGLRU æœƒæƒææŸä¸€å±¤ä¸­ gen X (page vectors)ï¼Œæ ¹æ“š page çš„ hot cold é€²è¡Œå›æ”¶</li><li>ä¹‹å¾Œé€šé <code>evict_folios</code> æª¢æŸ¥å¾Œç¢ºèªè¦å›æ”¶</li></ul><h3 id=pid-æ§åˆ¶è¿´è·¯èˆ‡-anonfile-backed-page-å¹³è¡¡>PID æ§åˆ¶è¿´è·¯èˆ‡ anon/file-backed page å¹³è¡¡</h3><p>MGLRU åœ¨ eviction æ±ºç­–ä¸­å¼•å…¥é¡ä¼¼æ–¼æ§åˆ¶è¿´è·¯ä¸­ PID æ§åˆ¶å™¨çš„å›é¥‹æ©Ÿåˆ¶ï¼Œç”¨æ–¼å¹³è¡¡ anon page å’Œ file-backed page çš„å›æ”¶æ¯”ä¾‹ã€‚æ•´å¥—æ©Ÿåˆ¶é€é Refault ç‡ç­‰æŒ‡æ¨™ä½œç‚ºå›é¥‹è¨Šè™Ÿä¾†èª¿æ•´ eviction ç­–ç•¥ï¼Œä½¿å¾— working set èƒ½å¤ å¾—åˆ°ä¿è­·ã€‚</p><ul><li><p>å›æ”¶ page é¡å‹é¸æ“‡ (P: æ¯”ä¾‹èª¿ç¯€): MGLRU æœƒæ¯”è¼ƒç›®å‰ anon page èˆ‡ file-backed page çš„ refault æ¯”ç‡ï¼Œå‚¾å‘å›æ”¶ refault æ¯”ç‡è¼ƒä½çš„ page é¡å‹ã€‚å¦‚æœæ¯ä¸€é¡ page è¢«å›æ”¶ä¹‹å¾Œå¾ˆå°‘è¢«å†æ¬¡å­˜å–ï¼Œä¹Ÿå°±æ˜¯å¾ˆå°‘è¢« refaultï¼Œé‚£è¡¨ç¤ºé€™ä¸€é¡å‹çš„ page å°æ–¼ç›®å‰çš„ working set ä¸é‡è¦ï¼Œå› æ­¤æŠŠé€™ä¸€äº› page å›æ”¶æ‰å°æ€§èƒ½å½±éŸ¿è¼ƒå°ï¼Œåä¹‹ï¼Œå¦‚æœæŸä¸€é¡å‹çš„ page ä¸æ–·è¢« refaultï¼Œå‰‡è¡¨ç¤ºé€™ä¸€é¡å‹çš„ page åŒ…å«ç›®å‰çš„ working setï¼Œæ‡‰è©²æ¸›å°‘å›æ”¶é€™ä¸€é¡å‹çš„ pageã€‚é€šéé€™ç¨®æ–¹å¼å»å¹³è¡¡ anon page å’Œ file-backed page çš„å›æ”¶æ¯”ä¾‹ (ç›¸æ¯”èµ· 2Q LRU ä½¿ç”¨ <code>swappiness</code> å›ºå®šæ¯”ä¾‹ï¼ŒMGLRU çš„å¯¦ç¾ç‚ºå‹•æ…‹èª¿æ•´)ã€‚</p><p>P è£¡é¢çš„æ¯”ç‡ï¼ŒæŒ‡çš„æ˜¯ refault ç‡</p></li><li><p>working set ä¿è­· (I: ç©åˆ†èª¿ç¯€): ç‚ºäº†é€²ä¸€æ­¥é¿å…æŸéƒ¨ä»½ working set è¢«éåº¦å›æ”¶ï¼ŒMGLRU å¼•å…¥ Tier å° page çš„å­˜å–é »ç‡é€²è¡Œåˆ†é¡ï¼Œä¸¦åŸºæ–¼æ­·å²çµ±è¨ˆæ•¸æ“šå°é€™ä¸€äº› page é€²è¡Œä¿è­·ã€‚æ¯å€‹ page éƒ½æœ‰ä¸€å€‹ 2-bit çš„æ¬„ä½ä½œç‚º Tier å€¼ï¼Œç¸½å…±åˆ†æˆå››å€‹å±¤ç´šã€‚Tier çš„è¨ˆç®—ä¸»è¦æ˜¯åŸºæ–¼è©² page é€šé syscall å¦‚ <code>read(), write()</code> çš„å­˜å–æ¬¡æ•¸ï¼Œå¦‚æœå­˜å–æ¬¡æ•¸ç‚º $n$ï¼Œå‰‡ Tier = $\lfloor \log_2(n) \rfloor$ï¼Œä¾‹å¦‚å¦‚æœä¸€å€‹ file-backed page åªè¢«è®€å–ä¸€æ¬¡ï¼Œå‰‡ Tier=0ã€‚è¢« syscall è®€å¯« 2 æ¬¡å‰‡ Tier = 1ã€‚anon page é€šå¸¸ä¸ä½¿ç”¨ Tier åŠƒåˆ†ã€‚MGLRU æœƒæŒçºŒçµ±è¨ˆå„å€‹ Tier ä¸­ page è¢«å›æ”¶å’Œ refault çš„æ¬¡æ•¸ï¼Œå¾è€Œè¨ˆç®—æ¯ä¸€ Tier çš„ refault ç‡ã€‚åœ¨ eviction éç¨‹ä¸­ï¼Œæœƒä½¿ç”¨åˆ°ç©åˆ†èª¿ç¯€çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯åƒè€ƒä¸€æ®µæ™‚é–“å…§çš„æ­·å²è³‡æ–™ï¼Œå¦‚æœæŸäº› Tier è¼ƒé«˜çš„ page æ­·å² refault ç‡åé«˜ï¼Œå³ä¾¿åœ¨æŸä¸€æ¬¡æƒææ™‚è©² page æ²’æœ‰è¢«å¼•ç”¨ï¼ŒMGLRU ä¹Ÿæœƒå°è©² page é€²è¡Œ protectï¼Œé¿å…ä¸€æ¬¡å›æ”¶éå¤šæ­¤ Tier çš„ pageã€‚ä½¿ç”¨éå»ç´¯ç©çš„ refault è¨Šæ¯èª¿ç¯€ eviction ç­–ç•¥ã€‚</p></li><li><p>D åœ¨ MGLRU ä¸­æ²’æœ‰ä½¿ç”¨</p></li></ul><p>ç¸½è€Œä¾†èªªï¼ŒMGLRU çš„ PID æ§åˆ¶è¿´è·¯å°‡ä¸Šé¢çš„ P èˆ‡ I çµåˆï¼ŒP å³æ™‚çš„èª¿æ•´å›æ”¶å‚¾å‘çš„ page é¡å‹ä»¥åŠå±¤ç´šï¼Œè€Œ I åŸºæ–¼æ­·å²çµ±è¨ˆå°é«˜ refault ç‡æˆ–æ˜¯é«˜ Tier çš„ page é€²è¡Œä¿è­·ï¼ŒP å’Œ I å…±åŒä½œç”¨é”æˆä¿ç•™ working set çš„æ•ˆæœã€‚ä¾‹å¦‚æŸæ®µæ™‚é–“å…§çš„ file-backed page çš„ refault ç‡é é«˜æ–¼ anon pageï¼ŒP æœƒæ›´å‚¾å‘å›æ”¶æ›´å¤š anon page ä»¥ä¿è­· working setï¼Œä¹Ÿå°±æ˜¯ä¿è­· file-backed pageã€‚åŒæ™‚å¦‚æœç™¼ç¾æŸ Tier çš„ refault ç‡æ•™é«˜ï¼Œå‰‡ I æœƒé™ä½è©² Tier page çš„å›æ”¶ï¼Œå¿…è¦æ™‚æœƒé‡å°å€‹åˆ¥ page é€²è¡Œ Protect (ç§»å…¥ <code>min_seq + 1</code>)ã€‚MGLRU å° <code>max_seq</code> çš„ anon page å’Œ file-backed page å§‹çµ‚æ˜¯åŒæ­¥çš„ï¼Œä½†æ˜¯å°æ–¼ <code>min_seq</code> æ˜¯ä¸åŒæ­¥çš„ï¼ŒåŸå› æ˜¯ç‚ºäº†å¯¦ç¾ä¸Šé¢çš„ PID å‹•æ…‹å¹³è¡¡æ©Ÿåˆ¶ã€‚å‚³çµ± 2Q LRU çš„ç¬¬äºŒæ¬¡å­˜å– page Promote åˆ° active list çš„æ©Ÿåˆ¶åœ¨ MGLRU ä¸­ä½¿ç”¨ gen ä»¥åŠä¸Šé¢çš„ Tier, PID è¿´è·¯æ©Ÿåˆ¶å–ä»£ï¼Œä¾‹å¦‚å°æ–¼æ–°æ˜ å°„çš„ pageï¼Œä¸€æ¬¡å­˜å–ç«‹å³æ”¾åˆ° <code>max_seq</code>ï¼Œè€Œå°æ–¼ syscall å­˜å–çš„ file-backed pageï¼Œå‰‡éœ€è¦é€šéå¤šæ¬¡å­˜å–ç´¯ç©ä¸€å®šçš„ Tier æ‰æœƒè¢« Promoteã€‚</p><h3 id=é—œæ–¼-bloom-filter-é™ä½-rmap-é–‹éŠ·>é—œæ–¼ Bloom Filter é™ä½ Rmap é–‹éŠ·</h3><p>MGLRU åœ¨ Aging éšæ®µå¼•å…¥äº† Bloom Filter é™ä½æƒæ Page Table å’Œ Rmap çš„é–‹éŠ·ã€‚2Q LRU åœ¨åˆ¤æ–· page æ˜¯å¦é€²è¡Œæœ‰è¢«ä½¿ç”¨æ™‚ï¼Œéœ€è¦å°æ¯å€‹ page é€²è¡Œ Rmap æ“ä½œä¾†å°‹æ‰€æœ‰æ˜ å°„è©² page çš„ PTE ä¸¦æª¢æŸ¥å…¶ Accessed bitï¼ŒRmap éœ€è¦å¤§é‡çš„é–‹éŠ·ï¼Œç‚ºæ­¤ï¼ŒRmap é€šéä»¥ä¸‹æ–¹å¼é€²è¡Œå„ªåŒ–</p><ul><li>ç†±å€ç´€éŒ„: åœ¨ eviction éç¨‹ä¸­ï¼Œç•¶åŸ·è¡Œ Rmap æª¢æŸ¥ page çš„å¼•ç”¨æ™‚ï¼ŒMGLRU æœƒåŒæ™‚æŸ¥çœ‹è©² page æ‰€åœ¨çš„ PMD æ˜¯å¦åŒ…å«å¤šå€‹è¢«å¼•ç”¨çš„ pageã€‚é€™éƒ¨ä»½é€šé <code>lru_gen_look_around()</code> å¯¦ç¾ï¼Œå¦‚æœ <code>lru_gen_look_around()</code> åœ¨ç›®æ¨™ page çš„é™„è¿‘ PTE ä¸­ç™¼ç¾å¤šå€‹ page çš„ Accessed Bit éƒ½æ˜¯ 1ï¼Œä¹Ÿå°±æ˜¯é€™ä¸€äº› page éƒ½å±¬æ–¼å¹´è¼•çš„ï¼Œå°±è¡¨ç¤ºé€™ä¸€æ•´ç‰‡ PMD éƒ½æ˜¯ hot pageã€‚MGLRU æœƒå°‡å°æ‡‰çš„ PMD entry ç´€éŒ„åˆ° Bloom Filter ä¸­ (é€šé <code>update_bloom_filter()</code> å°‡ PMD ç´€éŒ„åˆ° Bloom Filter)</li><li>double-buffering èˆ‡ flip filters: MGLRU ä½¿ç”¨ double-buffering çš„ Bloom Filter å¯¦ç¾ flip filterã€‚Bloom Filter å¯¦ç¾çš„è³‡æ–™çµæ§‹ç‚º Bit Map ä»¥åŠ hash functionï¼ŒBit Map å¤§å°ç‚º $m=2^{15}$ï¼Œhash function ä½¿ç”¨ 2 å€‹ï¼Œå¯åœ¨å®¹ç´ 10000 æ¢ entry æ™‚ä¿æŒè¼ƒä½çš„èª¤åˆ¤ç‡ã€‚æ¯æ¬¡ Aging è¿­ä»£çš„æ™‚å€™æœƒä½¿ç”¨ flip filter ç¿»è½‰åˆ°å¦å¤–ä¸€å€‹ Bloom Filterï¼Œå°‡æ–°ç™¼ç¾çš„ç†±å€ç´€éŒ„åˆ°ç›®å‰çš„ Bloom Filterï¼Œå¦ä¸€å€‹å‰‡æ¸…ç©ºæˆ–æ˜¯é€æ­¥æ·˜æ±°èˆŠè³‡è¨Šã€‚ç¢ºä¿ Bloom Filter ä¸­çš„å…§å®¹éš¨æ™‚é–“æ›´æ–°ï¼Œè£¡é¢çš„è³‡è¨Šç‚ºæœ€è¿‘å¹¾æ¬¡ eviction æ‰€ç™¼ç¾çš„ç†±å€ï¼Œè€Œä¸è‡³æ–¼ä¿ç•™éæ™‚çš„è¨Šæ¯</li><li>Page Table Walker: åœ¨ Aging æµç¨‹ä¸­ï¼Œkernel å°æ¯å€‹ process é€²è¡Œ Page Table èµ°è¨ªæ™‚ï¼Œæœƒå…ˆå°æ¯å€‹ PMD æŸ¥è©¢ Bloom Filter (<code>test_bloom_filter()</code>)ï¼Œå¦‚æœä¸€å€‹ PMD entry æˆ–æ˜¯å…¶ä»–ä¸­é–“ç¯€é»åœ¨ Bloom Filter ä¸­å­˜åœ¨ï¼Œè¡¨ç¤ºä¹‹å‰ eviction è©²å€åŸŸæ™‚è£¡é¢æœ‰ä¸å°‘ hot pageï¼Œå€¼å¾—æ·±å…¥èµ°è¨ªã€‚å¦‚æœ PMD entry ä¸åœ¨ Bloom Filter ä¸­ï¼Œå‰‡è©²å€åŸŸå¯èƒ½ hot page çš„åˆ†ä½ˆéå¸¸ç¨€ç–ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å†·çš„æˆ–æ˜¯æ²’æœ‰æ˜ å°„ï¼Œé€™æ™‚å€™æˆ‘å€‘å°±ä¸éœ€è¦å†æ·±å…¥èµ°è¨ªäº†ï¼Œå¯ä»¥ç›´æ¥è·³éã€‚é€šéé€™æ¨£å„ªåŒ–æ¸›å°‘éœ€è¦å®Œæ•´æƒæçš„ Page Table ç¯„åœã€‚é€šé Bloom Filter å¡é¸ï¼ŒPage Table Walker å¯ä»¥è·³éé‚£äº›å¾ˆå¯èƒ½æ˜¯å†·çš„å€åŸŸï¼Œå°ˆæ³¨èµ°è¨ªé‚£äº›å­˜åœ¨è¼ƒå¤š Accessed Bit ç‚º 1 çš„ pageã€‚</li><li>é™ä½ Rmap æ¬¡æ•¸: è¨±å¤š hot page æœƒåœ¨ Aging æ™‚è¢«æ¨™è¨˜ä¸¦åœ¨ eviction æ™‚ Promoteï¼Œè€Œ Bloom Filter åˆç¢ºä¿åœ¨ Aging éšæ®µä¸æœƒå°æ•´å€‹ç³»çµ±åšæ²’å¿…è¦çš„æƒæã€‚æ¯”èµ· 2Q LRU ä¾è³´ Rmap ä¸€å€‹ä¸€å€‹ page çš„æª¢æŸ¥æ–¹å¼ï¼ŒMGLRU ç›¸ç•¶æ–¼å°‡éƒ¨ä»½å·¥ä½œåˆ†æ”¤åœ¨å…¶ä»–éšæ®µè™•ç†<ul><li>åœ¨ Eviction æ™‚è—‰ç”±ä¸€æ¬¡ Rmap èµ°è¨ªæ”¶ç©«é¡å¤–é€±é‚Šå¤šå€‹ page çš„ Accessed è¨Šæ¯</li><li>åœ¨ Aging æ™‚åˆ©ç”¨ Eviction å¾—åˆ°çš„è¨Šæ¯é€²è¡Œæƒæ</li><li>MGLRU åœ¨ Eviction ä»¥åŠ Aging ä¹‹é–“å°±å»ºç«‹äº†ä¸€å€‹è¿´è·¯: Eviction ç™¼ç¾ç†±å€ -> æ›´æ–° Bloom Filter -> Aging æ ¹æ“š Bloom Filter é‡é»æå‡ hot pageã€‚
è—‰ç”±ä¸Šé¢é€™ç¨®è¨­è¨ˆï¼Œæ¸›å°‘ä¸å¿…è¦çš„ rmap æ“ä½œï¼Œæ¸›è¼•è¨˜æ†¶é«”å›æ”¶å° CPU çš„è² è¼‰ã€‚</li></ul></li></ul><h2 id=æ¸¬è©¦ç’°å¢ƒ>æ¸¬è©¦ç’°å¢ƒ</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ç™¼è¡Œç‰ˆ: Fedora
</span></span><span class=line><span class=cl>Linux Kernel Version: Linux apt 6.14.0-63.fc42.x86_64
</span></span></code></pre></td></tr></table></div></div><h3 id=ä½¿ç”¨-mglru-debugfs>ä½¿ç”¨ MGLRU debugfs</h3><p>é¦–å…ˆå»ºç«‹ cgroup</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir -p /sys/fs/cgroup/&lt;name&gt;
</span></span></code></pre></td></tr></table></div></div><p>æ¥è‘—æŠŠæŒ‡å®š process çš„ pid åŠ å…¥åˆ°è©² cgroup ä¸­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> pid <span class=p>|</span> sudo tee /sys/fs/cgroup/wkgrp/cgroup.procs
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡å®šè§€å¯Ÿçµ¦å®š process æ˜¯å¦åŠ å…¥åˆ°æŒ‡å®š cgroup ä¸­</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ systemd-cgls /sys/fs/cgroup/wkgrp
</span></span></code></pre></td></tr></table></div></div><p>æ¥è‘—åŸ·è¡Œ workload è§€å¯Ÿ <code>memory.stat</code>ï¼Œæˆ‘å€‘å¯ä»¥ç‰¹åˆ¥é¸å‡º <code>anon page</code> é€²è¡Œè§€å¯Ÿ (<code>malloc</code> å‡ºä¾†çš„ pageã€€å±¬æ–¼ <code>anon page</code>ï¼Œæˆ‘å€‘é »ç¹çš„å­˜å–é€™ä¸€äº› pageã€€é€™ä¸€äº› pageã€€å±¬æ–¼ active_anon)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>anon <span class=m>4296462336</span>
</span></span><span class=line><span class=cl>anon_thp <span class=m>0</span>
</span></span><span class=line><span class=cl>inactive_anon <span class=m>36864</span>
</span></span><span class=line><span class=cl>active_anon <span class=m>4296425472</span>
</span></span><span class=line><span class=cl>workingset_refault_anon <span class=m>0</span>
</span></span><span class=line><span class=cl>workingset_activate_anon <span class=m>0</span>
</span></span><span class=line><span class=cl>workingset_restore_anon <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥è‘—æˆ‘å€‘é€šé <code>lru_gen</code> å»æ§åˆ¶ pageï¼Œæˆ‘å€‘å¯ä»¥é€šéå»ºç«‹æ–°çš„ gen æŠŠç›®å‰åœ¨ active_anon æ“ åˆ° inactive_anon è£¡é¢ï¼Œå…ˆæŸ¥çœ‹ç›®å‰ <code>lru_gen</code>ã€€çš„è³‡è¨Š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>memcg Â Â 133 /wkgrp  
</span></span><span class=line><span class=cl>node Â Â Â Â 0  
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 14 Â Â Â 5208406 Â Â Â Â Â Â Â Â Â 9 Â Â Â Â Â Â Â Â Â Â 1 Â   
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 15 Â Â Â 5125504 Â Â Â Â Â Â Â Â Â 0 Â Â Â Â Â Â Â Â Â Â 0 Â   
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 16 Â Â Â 5108911 Â Â Â 1048932 Â Â Â Â Â Â Â Â Â Â 0 Â   
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 17 Â Â Â 5100847 Â Â Â Â Â Â Â Â Â 0 Â Â Â Â Â Â Â Â Â Â 0
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ç›®å‰ page éƒ½åœ¨ young gen è£¡é¢ï¼Œæˆ‘å€‘é€šéä»¥ä¸‹æŒ‡ä»¤å»ºç«‹æ–°çš„ genï¼Œæˆ‘å€‘åŸå…ˆåœ¨ young gen çš„ page æ‡‰è©²æœƒè¢«æ“ åˆ° old gen è£¡é¢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;+ 133 0 0 0&#34;</span> &gt; /sys/kernel/debug/lru_gen
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°æˆ‘å€‘çš„ page é€²å…¥åˆ°äº† old gen è£¡é¢</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>memcg Â Â 133 /wkgrp  
</span></span><span class=line><span class=cl>node Â Â Â Â 0  
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 16 Â Â Â 5159077 Â Â Â Â Â Â Â 302 Â Â Â Â Â Â Â Â Â Â 1 Â   
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 17 Â Â Â 5151013 Â Â Â 1048622 Â Â Â Â Â Â Â Â Â Â 0 Â   
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 18 Â Â Â Â Â 33125 Â Â Â Â Â Â Â Â 17 Â Â Â Â Â Â Â Â Â Â 0 Â   
</span></span><span class=line><span class=cl>Â Â Â Â Â Â Â Â 19 Â Â Â Â Â 21150 Â Â Â Â Â Â Â Â Â 0 Â Â Â Â Â Â Â Â Â Â 0
</span></span></code></pre></td></tr></table></div></div><p>è€Œ old gen ä»¥åŠ oldest gen éƒ½æ˜¯å±¬æ–¼ inactiveï¼Œæˆ‘å€‘å¯ä»¥åœ¨ <code>/sys/fs/cgroup/wkgrp/memory.stat</code> ä¸­çœ‹åˆ°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>anon 4296462336
</span></span><span class=line><span class=cl>anon_thp 0
</span></span><span class=line><span class=cl>inactive_anon 4296392704
</span></span><span class=line><span class=cl>active_anon 69632
</span></span><span class=line><span class=cl>workingset_refault_anon 0
</span></span><span class=line><span class=cl>workingset_activate_anon 0
</span></span><span class=line><span class=cl>workingset_restore_anon 0
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘å€‘å¯ä»¥åšä¸€å€‹å¯¦é©—ï¼Œæˆ‘å€‘å…ˆå˜—è©¦å­˜å–è³‡æ–™ï¼Œæ¥è‘—æŠŠé€™ä¸€äº›è³‡æ–™é€šé lru_genã€€é€²è¡Œ swapoutï¼Œæ¥è‘—å†æ¬¡é€²è¡Œå­˜å–ï¼Œæ¦‚å¿µä¸Šç‚ºä»¥ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@apt]/home/fedora# echo &#34;+ 133 0 0 0&#34; &gt; /sys/kernel/debug/lru_gen  
</span></span><span class=line><span class=cl>[root@apt]/home/fedora# echo &#34;+ 133 0 0 0&#34; &gt; /sys/kernel/debug/lru_gen  
</span></span><span class=line><span class=cl>[root@apt]/home/fedora# echo &#34;- 133 0 45 200&#34; &gt; /sys/kernel/debug/lru_gen
</span></span></code></pre></td></tr></table></div></div><p>å…ˆæŠŠæˆ‘å€‘çš„ hot page é€šéæ–°å»º gen ç§»å‹•åˆ° oldtest genï¼Œæ¥è‘—ç›´æ¥å›æ”¶æœ€å¾Œä¸€å€‹ä¸–ä»£ï¼Œ200 è¡¨ç¤º swapinessï¼Œå°‡å…¶æ›å‡ºåˆ° swapspace ä¸­ï¼Œæˆ‘å€‘å¯ä»¥é€šé <code>cat /sys/fs/cgroup/wkgrp/memory.swap.current</code> æŸ¥çœ‹ swapspace å¤§å°ï¼Œä»¥ä¸‹ç‚ºæ¸¬è©¦ç¨‹å¼ç¢¼</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define _GNU_SOURCE
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define STEP 4096
</span></span></span><span class=line><span class=cl><span class=cp>#define NSEC(ns) ((double)(ns) / 1e9)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>cold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>touch</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>sz</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sz</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=n>STEP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>buf</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>++</span><span class=p>;</span> <span class=cm>/* read-modify-write */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>uint64_t</span> <span class=nf>mono_ns</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>timespec</span> <span class=n>ts</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>clock_gettime</span><span class=p>(</span><span class=n>CLOCK_MONOTONIC_RAW</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ts</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=kt>uint64_t</span><span class=p>)</span><span class=n>ts</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>*</span> <span class=mf>1e9</span> <span class=o>+</span> <span class=n>ts</span><span class=p>.</span><span class=n>tv_nsec</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>cold_mib</span> <span class=o>=</span> <span class=n>argc</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>?</span> <span class=nf>strtoull</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span> <span class=o>:</span> <span class=mi>4096</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>wait_sec</span> <span class=o>=</span> <span class=n>argc</span> <span class=o>&gt;</span> <span class=mi>2</span> <span class=o>?</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>:</span> <span class=mi>30</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>cold_sz</span> <span class=o>=</span> <span class=n>cold_mib</span> <span class=o>*</span> <span class=p>(</span><span class=mi>1UL</span> <span class=o>&lt;&lt;</span> <span class=mi>20</span><span class=p>);</span> <span class=cm>/* bytes */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* -------- malloc &amp; fault-in -------- */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>posix_memalign</span><span class=p>((</span><span class=kt>void</span> <span class=o>**</span><span class=p>)</span><span class=o>&amp;</span><span class=n>cold</span><span class=p>,</span> <span class=mi>4096</span><span class=p>,</span> <span class=n>cold_sz</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;alloc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>cold</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>cold_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;PID=%d cold=%zu MiB  wait=%d s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>getpid</span><span class=p>(),</span> <span class=n>cold_mib</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>wait_sec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* -------- Phase-1: é¦–æ¬¡è§¸ç¢° -------- */</span>
</span></span><span class=line><span class=cl>  <span class=nf>touch</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>cold</span><span class=p>,</span> <span class=n>cold_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;Phase-1 done, cold pages fault-in &amp; active</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* -------- Phase-2: ç­‰å¾… mglru æ“ä½œ -------- */</span>
</span></span><span class=line><span class=cl>  <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;Sleep %d s, you may run mglru_ctl nowâ€¦</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>wait_sec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>sleep</span><span class=p>(</span><span class=n>wait_sec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* -------- Phase-3: é‡æ–°è§¸ç¢° &amp; é‡æ™‚é–“ -------- */</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>t0</span> <span class=o>=</span> <span class=nf>mono_ns</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>touch</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>cold</span><span class=p>,</span> <span class=n>cold_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=n>t1</span> <span class=o>=</span> <span class=nf>mono_ns</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>double</span> <span class=n>sec</span> <span class=o>=</span> <span class=nf>NSEC</span><span class=p>(</span><span class=n>t1</span> <span class=o>-</span> <span class=n>t0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Re-access %.0f MiB took %.3f s  (%.1f MiB/s)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>double</span><span class=p>)</span><span class=n>cold_mib</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=n>sec</span><span class=p>,</span> <span class=n>cold_mib</span> <span class=o>/</span> <span class=n>sec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¸åšä»»ä½•èª¿æ•´çš„æƒ…æ³å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PID=2696594 cold=8192 MiB  wait=10 s
</span></span><span class=line><span class=cl>Phase-1 done, cold pages fault-in &amp; active
</span></span><span class=line><span class=cl>Sleep 10 s, you may run mglru_ctl nowâ€¦
</span></span><span class=line><span class=cl>Re-access 8192 MiB took 0.046 s  (179475.2 MiB/s)
</span></span></code></pre></td></tr></table></div></div><p>æ¥è‘—æˆ‘å€‘å˜—è©¦å°‡ hot page swap out</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PID=2697859 cold=8192 MiB  wait=60 s
</span></span><span class=line><span class=cl>Phase-1 done, cold pages fault-in &amp; active
</span></span><span class=line><span class=cl>Sleep 60 s, you may run mglru_ctl nowâ€¦
</span></span><span class=line><span class=cl>Re-access 8192 MiB took 2.986 s  (2743.4 MiB/s)
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°æ•ˆèƒ½å‡ºç¾äº†å·¨å¤§çš„ä¸‹æ»‘ï¼Œå› ç‚ºé€™æ™‚å€™æ˜¯å¾ç¡¬ç¢Ÿä¸­è®€å–è³‡æ–™ï¼Œå¾ä»¥ä¸Šè­‰æ˜äº† lru_gen çš„å¯è¡Œæ€§</p><h3 id=ä½¿ç”¨-kprobe-è§€æ¸¬-funciton-è¡Œç‚º>ä½¿ç”¨ kprobe è§€æ¸¬ funciton è¡Œç‚º</h3><p>å¦‚æœæˆ‘å€‘æƒ³è¦è§€å¯Ÿ kernel function å…§éƒ¨è¡Œç‚ºï¼Œä»¥ MGLRU ç‚ºä¾‹å­ï¼Œæˆ‘å€‘å¯èƒ½æƒ³è¦è§€å¯Ÿå…·é«”é€²å…¥ lruvec_folio çš„ page ä¸€äº›è³‡è¨Šï¼Œå¦‚ä»–æ‰€åœ¨çš„ gen ç­‰ç­‰å»é©—è­‰æˆ‘å€‘çš„æ¨è«–æ˜¯å¦æ­£ç¢ºï¼Œå°æ–¼é€™äº›æƒ…æ³ï¼Œæˆ‘å€‘æœ‰è¨±å¤šæ–¹å¼å¯ä»¥å¯¦ç¾å° kernel function çš„è§€å¯Ÿï¼Œä»¥ä¸‹åˆ†æˆéœæ…‹èˆ‡å‹•æ…‹çš„æ–¹å¼</p><h3 id=éœæ…‹è¿½è¹¤>éœæ…‹è¿½è¹¤</h3><p>Tracepoint: ç‚º Linux Kernel ä¸­ä¸€ç¨®éœæ…‹æ’æ¨ (static instrumentation) æ©Ÿåˆ¶ï¼Œå¯ä»¥åœ¨åŸå§‹ç¢¼ä¸­å‡½å¼éƒ¨ä»½é å…ˆå®šç¾© hook pointsï¼Œç”¨ä¾†ç›£æ§èˆ‡è¿½è¹¤ kernel çš„è¡Œç‚ºã€‚Tracepoint åœ¨ç·¨è­¯æ™‚æœƒåµŒå…¥åˆ° kernel ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>sudo perf list tracepoint</code> æŸ¥çœ‹å¯ç”¨çš„ tracepointã€‚</p><p>ä¸éç¼ºé»ä¹Ÿå¾ˆæ˜é¡¯ï¼Œå°æ–¼æ²’æœ‰é å…ˆå®šç¾© tracepoint çš„ functionï¼Œæˆ‘å€‘æœƒéœ€è¦ä¿®æ”¹ä¸¦é‡æ–°ç·¨è­¯ kernelã€‚</p><h3 id=å‹•æ…‹è¿½è¹¤>å‹•æ…‹è¿½è¹¤</h3><p>kprobe: å¯ä»¥å‹•æ…‹çš„åœ¨ kernel funciton ä¸­ä»»æ„ä½ç½®æ’å…¥æ¢é‡ï¼Œå¯ä»¥ç„¡é ˆé‡æ–°ç·¨è­¯ kernelï¼Œä¸éœ€è¦ä¿®æ”¹ kernel codeã€‚</p><p>å°æ–¼å·²ç¶“åœ¨ kallsym ä¸­çš„ functionï¼Œæˆ‘å€‘å¯ä»¥å¾ˆè¼•é¬†ç›´æ¥ä½¿ç”¨ symbol name å» kprobeï¼Œä½†æ˜¯å°æ–¼ä¸åœ¨ kallsym çš„ functionï¼Œå¦‚ä¸€äº›è¢« compiler å„ªåŒ–æ‰çš„ symbol æˆ–æ˜¯ inlineï¼Œæˆ‘å€‘æœƒéœ€è¦å¾—åˆ°è©² function çš„ function addressï¼Œå…·é«”ä½œæ³•ç‚ºæˆ‘å€‘éœ€è¦ kernel-debuginfo é…åˆ DWARF å»å¾—å‡ºè©² function çš„åœ°å€ï¼Œé€™é»æ˜¯å¾ <code>perf probe</code> ä¸­æ„å¤–ç™¼ç¾çš„ï¼Œç™¼ç¾ <code>perf probe -L &lt;function_name></code> å¯ä»¥å°å‡º function çš„ source codeï¼Œæ–¼æ˜¯æˆ‘å˜—è©¦ä»¥ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo perf probe -L try_to_inc_max_seq                                       
</span></span><span class=line><span class=cl>Failed to find the path <span class=k>for</span> the kernel: No such file or directory
</span></span><span class=line><span class=cl>  Error: Failed to show lines.
</span></span></code></pre></td></tr></table></div></div><p>å‡ºç¾ä»¥ä¸ŠéŒ¯èª¤ï¼Œå˜—è©¦ä½¿ç”¨ <code>strace</code> å° <code>perf probe</code> é€²è¡Œè¿½è¹¤å¾Œç™¼ç¾æ˜¯ä¾è³´æ–¼ debug-infoï¼Œä»¥ä¸‹ç‚º <code>strace perf probe -L &lt;function_name></code> çš„è¼¸å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>- openat(AT_FDCWD, &#34;/usr/lib/debug/usr/lib/debug/lib/modules/6.14.0-63.fc42.x86_64/vmlinux.debug&#34;, O_RDONLY)
</span></span><span class=line><span class=cl>- openat(AT_FDCWD, &#34;/usr/lib/debug/usr/lib/debug/lib/modules/6.14.0-63.fc42.x86_64/vmlinux&#34;, O_RDONLY)
</span></span><span class=line><span class=cl>- openat(AT_FDCWD, &#34;/usr/lib/debug/lib/modules/6.14.0-63.fc42.x86_64/.debug/vmlinux&#34;, O_RDONLY)
</span></span><span class=line><span class=cl>- openat(AT_FDCWD, &#34;/usr/lib/debug/.build-id/a9/1e7e0ceeb1cc106e37bf89b80a69b39844a559.debug&#34;, O_RDONLY)
</span></span></code></pre></td></tr></table></div></div><p>ä»¥ fedora ç‚ºä¾‹å­ï¼Œé€šéä»¥ä¸‹æŒ‡ä»¤æˆ‘å€‘å¯ä»¥å¾—åˆ° kernel-debuginfo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo dnf --enablerepo<span class=o>=</span>fedora-debuginfo,updates-debuginfo install kernel-debuginfo
</span></span></code></pre></td></tr></table></div></div><p>æ¥è‘—å†æ¬¡ä½¿ç”¨ <code>strace perf probe -L &lt;function_name></code> å³å¯æ­£å¸¸åŸ·è¡Œï¼Œä¸¦ä¸”é‚„èƒ½å¤ åˆ—å‡ºä¸åœ¨ System.map ä»¥åŠ kallsyms è£¡é¢çš„ function è³‡è¨Šï¼Œæ–¼æ˜¯æˆ‘æƒ³è¦é€šé debuginfo å»å¾—åˆ°é‚£äº›è¢«å„ªåŒ–æ‰çš„ function çš„è¨˜æ†¶é«”åœ°å€</p><p>debuginfo æœƒä½æ–¼ <code>/usr/lib/debug/lib/modules/$(uname -r)/vmlinux</code> åº•ä¸‹ï¼Œæ¥è‘—æˆ‘å€‘å¯ä»¥é€šéä»¥ä¸‹è…³æœ¬å»å¾—åˆ°ä»»ä¸€ function çš„è¨˜æ†¶é«”åœ°å€</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_function_start_address</span><span class=p>(</span><span class=n>function_name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>kernel_release</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>uname</span><span class=p>()</span><span class=o>.</span><span class=n>release</span>
</span></span><span class=line><span class=cl>    <span class=n>vmlinux_path</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;/usr/lib/debug/lib/modules/</span><span class=si>{</span><span class=n>kernel_release</span><span class=si>}</span><span class=s2>/vmlinux&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>vmlinux_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Using gdb read vmlinux and get function address</span>
</span></span><span class=line><span class=cl>    <span class=n>cmd</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gdb&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-batch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;-ex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;info line </span><span class=si>{</span><span class=n>function_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>vmlinux_path</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>check_output</span><span class=p>(</span><span class=n>cmd</span><span class=p>,</span> <span class=n>stderr</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>STDOUT</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;GDB execution failed:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;starts at address ([\w]+)&#34;</span><span class=p>,</span> <span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=k>match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Failed to find start address.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Usage: sudo python3 </span><span class=si>{</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> &lt;function_name&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>function</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=n>get_function_start_address</span><span class=p>(</span><span class=n>function</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>addr</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>function</span><span class=si>}</span><span class=s2> starts at address: </span><span class=si>{</span><span class=n>addr</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>æœ‰äº† function address ä¹‹å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥ç”¨ kprobe å»æ¢æ¸¬ä¸¦è§€å¯Ÿå…¶å…§éƒ¨è³‡æ–™çµæ§‹è³‡è¨Šã€‚</p><p>ä½¿ç”¨ kprobe æœ‰ä»¥ä¸‹å…©ç¨®æ–¹å¼</p><ul><li>ä½¿ç”¨ <code>bpftrace</code></li><li>ä½¿ç”¨ kernel module</li></ul><h4 id=ä½¿ç”¨-kernel-module>ä½¿ç”¨ kernel module</h4><p>ä»¥ <code>try_to_shrink_lruvec</code> ç‚ºä¾‹å­ï¼Œå¦‚æœæˆ‘å€‘æƒ³è¦å¾—çŸ¥ <code>lruvec</code> è£¡é¢å…·é«” page çš„æƒ…æ³æˆ–æ˜¯ gen ç­‰ç­‰ï¼Œæˆ‘å€‘å¯ä»¥é€šéä»¥ä¸‹ kprobe pre handler å­˜å– function å…§çš„è®Šæ•¸</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>handler_pre</span><span class=p>(</span><span class=k>struct</span> <span class=n>kprobe</span> <span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=k>struct</span> <span class=n>pt_regs</span> <span class=o>*</span><span class=n>regs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>lruvec</span> <span class=o>*</span><span class=n>lruvec</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>lru_gen_folio</span> <span class=o>*</span><span class=n>lrugen</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>gen</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=n>zone</span><span class=p>,</span> <span class=n>page_refcount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lruvec</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>lruvec</span> <span class=o>*</span><span class=p>)</span><span class=n>regs</span><span class=o>-&gt;</span><span class=n>di</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>lruvec</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>pr_warn</span><span class=p>(</span><span class=s>&#34;lruvec is NULL</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>lrugen</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>lruvec</span><span class=o>-&gt;</span><span class=n>lrugen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>lrugen</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>pr_warn</span><span class=p>(</span><span class=s>&#34;lrugen is NULL</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;[KPROBE] try_to_shrink_lruvec called</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;[KPROBE] max_seq: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>lrugen</span><span class=o>-&gt;</span><span class=n>max_seq</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>gen</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>gen</span> <span class=o>&lt;</span> <span class=n>MAX_NR_GENS</span><span class=p>;</span> <span class=n>gen</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>type</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>type</span> <span class=o>&lt;</span> <span class=n>ANON_AND_FILE</span><span class=p>;</span> <span class=n>type</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>zone</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>zone</span> <span class=o>&lt;</span> <span class=n>MAX_NR_ZONES</span><span class=p>;</span> <span class=n>zone</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>struct</span> <span class=n>list_head</span> <span class=o>*</span><span class=n>head</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>struct</span> <span class=n>folio</span> <span class=o>*</span><span class=n>folio</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>struct</span> <span class=n>page</span> <span class=o>*</span><span class=n>page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=kt>long</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>head</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>lrugen</span><span class=o>-&gt;</span><span class=n>folios</span><span class=p>[</span><span class=n>gen</span><span class=p>][</span><span class=n>type</span><span class=p>][</span><span class=n>zone</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>head</span> <span class=o>||</span> <span class=nf>list_empty</span><span class=p>(</span><span class=n>head</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;Generation %d, type %s, zone %d:</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>gen</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=p>(</span><span class=n>type</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>?</span> <span class=s>&#34;anon&#34;</span> <span class=o>:</span> <span class=s>&#34;file&#34;</span><span class=p>),</span> <span class=n>zone</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nf>list_for_each_entry</span><span class=p>(</span><span class=n>folio</span><span class=p>,</span> <span class=n>head</span><span class=p>,</span> <span class=n>lru</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>folio</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nf>pr_warn</span><span class=p>(</span><span class=s>&#34;NULL folio in list</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=n>page</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>folio</span><span class=o>-&gt;</span><span class=n>page</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>page_refcount</span> <span class=o>=</span> <span class=nf>page_ref_count</span><span class=p>(</span><span class=n>page</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>pfn</span> <span class=o>=</span> <span class=nf>page_to_pfn</span><span class=p>(</span><span class=n>page</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>page_phys_addr</span> <span class=o>=</span> <span class=nf>PFN_PHYS</span><span class=p>(</span><span class=n>pfn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=kt>bool</span> <span class=n>dirty</span> <span class=o>=</span> <span class=nf>PageDirty</span><span class=p>(</span><span class=n>page</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=kt>bool</span> <span class=n>writeback</span> <span class=o>=</span> <span class=nf>PageWriteback</span><span class=p>(</span><span class=n>page</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                    <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;(folio: %px) (page addr: %px) (page phys addr: %px) (page ref count: %d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>folio</span><span class=p>,</span> <span class=n>page</span><span class=p>,</span> <span class=n>page_phys_addr</span><span class=p>,</span> <span class=n>page_refcount</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ ¹æ“š x86 calling convention æˆ‘å€‘çŸ¥é“ç¬¬ä¸€å€‹åƒæ•¸ä½æ–¼ <code>rdi</code> æš«å­˜å™¨ä¸­ï¼Œæ¥è‘—æŒ‰ç…§ MGLRU é—œéµè³‡æ–™çµæ§‹ï¼Œç”± <code>lruvec</code> å­˜å– <code>lrugen</code>ï¼Œæ¥è‘—ä¾ç…§ <code>gen</code>, <code>type</code>, <code>zone</code> èµ°è¨ª folio list ä¾¿å¯ä»¥å¾—åˆ° page è³‡è¨Šã€‚</p><p>æ¥è‘—æŒ‡å®šæˆ‘å€‘è¦ hook çš„ function ä»¥åŠå°æ‡‰çš„ pre handler ä¾¿å®Œæˆè¨»å†Š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>mglru_monitor_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>kp</span><span class=p>.</span><span class=n>symbol_name</span> <span class=o>=</span> <span class=s>&#34;try_to_shrink_lruvec&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>kp</span><span class=p>.</span><span class=n>pre_handler</span> <span class=o>=</span> <span class=n>handler_pre</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>register_kprobe</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>pr_err</span><span class=p>(</span><span class=s>&#34;register_kprobe failed, returned %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>pr_info</span><span class=p>(</span><span class=s>&#34;MGLRU monitor module loaded.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœæˆ‘å€‘è¦ hook çš„ function çš„ symbol åœ¨ System.map ä¸­æŸ¥è©¢ä¸åˆ°ï¼Œè€Œæ˜¯ä½¿ç”¨ Debuginfo å¾—åˆ°çš„ raw addressï¼Œå‰‡éœ€è¦ä½¿ç”¨ä»¥ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>__init</span> <span class=nf>kprobe_stack_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>kp</span><span class=p>.</span><span class=n>addr</span> <span class=o>=</span> <span class=p>(</span><span class=kt>kprobe_opcode_t</span> <span class=o>*</span><span class=p>)</span><span class=n>FUNCTION_ADDRESS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>kp</span><span class=p>.</span><span class=n>pre_handler</span> <span class=o>=</span> <span class=n>handler_pre</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>register_kprobe</span><span class=p>(</span><span class=o>&amp;</span><span class=n>kp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆåŠŸåŸ·è¡Œå¾Œæˆ‘å€‘ä¾¿å¯ä»¥å¾—åˆ°å…·é«”é€²å…¥åˆ° <code>try_to_shrink_lruvec()</code> çš„ page ç›¸é—œè³‡è¨Šï¼Œå¾—åˆ°ä»¥ä¸‹è¼¸å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo dmesg
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000568<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e480<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e480<span class=o>)</span> <span class=o>(</span>page phys addr: 0000000520392000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000569<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e440<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e440<span class=o>)</span> <span class=o>(</span>page phys addr: 0000000520391000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000570<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e400<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e400<span class=o>)</span> <span class=o>(</span>page phys addr: 0000000520390000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000571<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e3c0<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e3c0<span class=o>)</span> <span class=o>(</span>page phys addr: 000000052038f000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000572<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e380<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e380<span class=o>)</span> <span class=o>(</span>page phys addr: 000000052038e000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000574<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e340<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e340<span class=o>)</span> <span class=o>(</span>page phys addr: 000000052038d000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000575<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e300<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e300<span class=o>)</span> <span class=o>(</span>page phys addr: 000000052038c000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000576<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e2c0<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e2c0<span class=o>)</span> <span class=o>(</span>page phys addr: 000000052038b000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000577<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e280<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e280<span class=o>)</span> <span class=o>(</span>page phys addr: 000000052038a000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>29971.000578<span class=o>]</span> <span class=o>(</span>folio: ffffea001480e240<span class=o>)</span> <span class=o>(</span>page addr: ffffea001480e240<span class=o>)</span> <span class=o>(</span>page phys addr: 0000000520389000<span class=o>)</span> <span class=o>(</span>page ref count: 1<span class=o>)</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><h4 id=ä½¿ç”¨-bpftrace>ä½¿ç”¨ bpftrace</h4><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ oneline æŒ‡ä»¤æŸ¥çœ‹çµ¦å®š function å‚³éçš„åƒæ•¸</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo bpftrace -e <span class=s1>&#39;kprobe:try_to_shrink_lruvec { $lruvec = (struct lruvec *)arg0; printf(&#34;[KPROBE] try_to_shrink_lruvec called, lruvec: %px, max_seq: %lu\n&#34;, $lruvec, $lruvec-&gt;lrugen.max_seq); }&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ–æ˜¯ç›´æ¥ä½¿ç”¨ raw function address (å¦‚æœ function ä¸åœ¨ kernel symbol tableï¼Œå¯ä»¥ä½¿ç”¨ <code>sudo bpftrace -l</code> æŸ¥è©¢)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo bpftrace -e <span class=s1>&#39;kprobe:0xffffffff81684c0c { printf(&#34;arg0=%lx\n&#34;, arg0);}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ–æ˜¯å°‡ä»¥ä¸‹æª”æ¡ˆå„²å­˜æˆ .btï¼Œä½¿ç”¨ <code>sudo bpftrace</code> åŸ·è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#!/usr/bin/env bpftrace
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=n>BEGIN</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Trace try_to_shrink_lruvec function</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Press Ctrl+C to stop</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>kprobe</span><span class=p>:</span><span class=n>try_to_shrink_lruvec</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>$</span><span class=n>lruvec</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>lruvec</span> <span class=o>*</span><span class=p>)</span><span class=n>arg0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=err>$</span><span class=n>lruvec</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[Warning]: lruvec is NULL</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[KPROBE] try_to_shrink_lruvec been called</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[KPROBE] lruvec address: %px</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=err>$</span><span class=n>lruvec</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[KPROBE] timestramp: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>nsecs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[KPROBE] process PID: %d, process_name: %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>pid</span><span class=p>,</span> <span class=n>comm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[KPROBE] max_seq: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=err>$</span><span class=n>lruvec</span><span class=o>-&gt;</span><span class=n>lrugen</span><span class=p>.</span><span class=n>max_seq</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[KPROBE] call_count: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>++</span><span class=err>@</span><span class=n>call_count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;---</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>END</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;total call_count: %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=err>@</span><span class=n>call_count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;End</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢æ˜¯ä¸€å€‹ç°¡å–®çš„æ¸¬è©¦ç¯„ä¾‹ï¼Œå¦‚æœæˆ‘å€‘è¦å° lruvec è£¡é¢çš„æˆå“¡é€²è¡Œéæ­·ç­‰ç­‰ï¼Œä½¿ç”¨ bpftrace æœƒéå¸¸é›£å»å¯¦ç¾ï¼Œå› ç‚ºç„¡æ³•ä½¿ç”¨è®Šæ•¸ä½œç‚ºé™£åˆ—çš„ç´¢å¼•ä¸”ä¸€äº› kernel ä¸­çš„å·¨é›†ä¹Ÿç„¡æ³•ä½¿ç”¨ã€‚</p><p>å¦‚æœåªæ˜¯æŸ¥çœ‹å‚³éåƒæ•¸ç­‰ç­‰ï¼Œå¯ä»¥å¿«é€Ÿçš„ä½¿ç”¨ bpftrace é€²è¡Œå¯¦ç¾ï¼Œéœ€è¦é€²ä¸€æ­¥å°åƒæ•¸é€²è¡Œè§£æå‰‡ä½¿ç”¨ Kernel Module é€²è¡Œå¯¦ç¾ã€‚</p><h2 id=çµè«–>çµè«–</h2><ul><li>è§£é‡‹äº† MGLRU æ”¹é€²ä»¥åŠå¤§è‡´é‹ä½œæµç¨‹</li><li>é‹ç”¨ Flamegraph/dot-graph å° kernel å­ç³»çµ±é€²è¡Œåˆ†æ</li><li>é‹ç”¨ kprobe å° kernel æŸå€‹ function é€²è¡Œç²¾ç´°åˆ†æ</li></ul><h2 id=reference>Reference</h2><ul><li><a class=link href="https://www.youtube.com/watch?v=9HvJfN21H9Y&amp;ab_channel=TheLinuxFoundation" target=_blank rel=noopener>MGLRU - Yu Zhao</a></li><li><a class=link href=https://www.kernel.org/doc/html/v6.1/mm/multigen_lru.html target=_blank rel=noopener>Multi-Gen LRU</a></li><li><a class=link href=https://www.kernel.org/doc/html/v6.1/mm/multigen_lru.html target=_blank rel=noopener>Multi-Gen LRU Kernel.org</a></li><li><a class=link href=https://github.com/brendangregg/FlameGraph target=_blank rel=noopener>brendangregg/FlameGraph</a></li><li><a class=link href=https://github.com/jrfonseca/gprof2dot target=_blank rel=noopener>jrfonseca/gprof2dot</a></li><li><a class=link href=https://docs.kernel.org/trace/kprobes.html target=_blank rel=noopener>Linux Kprobe</a></li><li><a class=link href="https://www.youtube.com/watch?v=UVM3WX8Lq2k&amp;ab_channel=KernelRecipes" target=_blank rel=noopener>Kernel Recipes 2017 - Perf in Netflix - Brendan Gregg</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/mglru/>MGLRU</a>
<a href=/tags/linux-kernel/>Linux Kernel</a>
<a href=/tags/tracing/>Tracing</a>
<a href=/tags/perf/>Perf</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script><script>const gitalk=new Gitalk({clientID:"Ov23lij78DRsoaL8R1yu",clientSecret:"5ab179141bce2450541712ea80b407edfbbd3efb",repo:"WuTa0209.github.io",owner:"WuTa0209",admin:["WuTa0209"],distractionFreeMode:!1,id:md5(location.pathname),proxy:"https://wuta0209.hank20010209.workers.dev/?https://github.com/login/oauth/access_token"});(function(){const e=["localhost","127.0.0.1"],t=window.location.hostname;if(e.includes(t)){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 WuTa Blog</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> å»ºç«‹<br>ä¸»é¡Œ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è¨­è¨ˆ</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>